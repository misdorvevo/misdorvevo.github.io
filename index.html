<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will Hatch - Desktop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Desktop Environment -->
    <div class="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icons">
            <div class="desktop-icon" data-file="My Computer">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <rect x="2" y="3" width="20" height="13" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
                    <line x1="2" y1="3" x2="22" y2="3" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="2" y1="3" x2="2" y2="16" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="22" y1="3" x2="22" y2="16" stroke="#808080" stroke-width="1"/>
                    <line x1="2" y1="16" x2="22" y2="16" stroke="#808080" stroke-width="1"/>
                    <rect x="3" y="4" width="18" height="11" fill="#000080" stroke="#000" stroke-width="0.5"/>
                    <rect x="4" y="5" width="16" height="3" fill="#00aaff"/>
                    <rect x="4" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="7" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="10" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="8" y="17" width="8" height="2" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/>
                    <rect x="11" y="19" width="2" height="2" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/>
                </svg>
                <div class="icon-label">My Computer</div>
            </div>
            <div class="desktop-icon" data-file="My Documents">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                    <rect x="5" y="9" width="5" height="7" fill="#ffffff" stroke="#000" stroke-width="0.5"/>
                    <line x1="5.5" y1="10" x2="9.5" y2="10" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="11" x2="9.5" y2="11" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="12" x2="9.5" y2="12" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="13" x2="8.5" y2="13" stroke="#000" stroke-width="0.3"/>
                    <rect x="11" y="10" width="5" height="6" fill="#ffffff" stroke="#000" stroke-width="0.5"/>
                    <line x1="11.5" y1="11" x2="15.5" y2="11" stroke="#000" stroke-width="0.3"/>
                    <line x1="11.5" y1="12" x2="15.5" y2="12" stroke="#000" stroke-width="0.3"/>
                    <line x1="11.5" y1="13" x2="14.5" y2="13" stroke="#000" stroke-width="0.3"/>
                </svg>
                <div class="icon-label">My Documents</div>
            </div>
            <div class="desktop-icon" data-file="Readme.txt">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                    <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                    <rect x="3" y="2" width="14" height="3" fill="#000080"/>
                    <text x="10" y="4" font-size="2" text-anchor="middle" fill="#ffffff" font-weight="bold">TXT</text>
                    <line x1="4" y1="7" x2="16" y2="7" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="8.5" x2="15" y2="8.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="10" x2="16" y2="10" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="11.5" x2="14" y2="11.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="13" x2="16" y2="13" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="14.5" x2="15" y2="14.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="16" x2="16" y2="16" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="17.5" x2="13" y2="17.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="19" x2="15" y2="19" stroke="#000" stroke-width="0.4"/>
                </svg>
                <div class="icon-label">Readme.txt</div>
            </div>

        </div>

        <!-- Start Menu -->
        <div class="start-menu" id="start-menu">
            <div class="start-menu-header">
                <div class="start-menu-logo">Windows 95</div>
            </div>
            <div class="start-menu-items">
                <div class="menu-item" onclick="windowManager.openFolder('Program Files')">
                    <span class="menu-icon">▶</span>
                    <span>Programs</span>
                </div>
                <div class="menu-item" onclick="windowManager.openFolder('My Music')">
                    <span class="menu-icon">▶</span>
                    <span>Documents</span>
                </div>
                <div class="menu-item" onclick="windowManager.openFolder('Windows')">
                    <span class="menu-icon">▶</span>
                    <span>Settings</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item" onclick="alert('Help system not implemented')">
                    <span>Find</span>
                </div>
                <div class="menu-item" onclick="alert('Help system not implemented')">
                    <span>Help</span>
                </div>
                <div class="menu-item" onclick="alert('Run dialog not implemented')">
                    <span>Run...</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item" onclick="if(confirm('Shut down the computer?')) alert('Computer shutdown initiated')">
                    <span>Shut Down...</span>
                </div>
            </div>
        </div>

        <div class="windows-container" id="windows-container"></div>

        <!-- Taskbar -->
        <div class="taskbar">
            <div class="taskbar-start">
                <button class="start-button" id="start-button">Start</button>
            </div>
            <div class="taskbar-windows" id="taskbar-windows"></div>
            <div class="taskbar-tray">
                <span class="system-time" id="system-time">12:00</span>
            </div>
        </div>
    </div>

    <script>
        // debugging helpers
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('JS Error:', message, 'at', source + ':' + lineno + ':' + colno, error);
            alert('JavaScript error: ' + message + ' at ' + lineno + ':' + colno);
        };
        alert('script starting');
        console.log('script loaded');

        // ============= FULLY FUNCTIONAL APPLICATIONS - ALL WORKING =============

        // ============= APPLICATION CLASSES =============
        class CalculatorApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.display = windowEl.querySelector('#calc-display');
                this.display.value = '0';
                this.current = '0';
                this.previous = '';
                this.operation = null;
                this.newNumber = true;
                this.setupHandlers();
            }

            setupHandlers() {
                const display = this.display;
                const buttons = this.windowEl.querySelectorAll('.calc-btn');
                
                buttons.forEach(btn => {
                    if (btn.textContent === 'C') {
                        btn.addEventListener('click', () => this.clear());
                    } else if (btn.textContent === '←') {
                        btn.addEventListener('click', () => this.backspace());
                    } else if (['+', '-', '*', '/'].includes(btn.textContent)) {
                        btn.addEventListener('click', () => this.setOperation(btn.textContent));
                    } else if (btn.textContent === '=') {
                        btn.addEventListener('click', () => this.calculate());
                    } else if (btn.textContent === '.') {
                        btn.addEventListener('click', () => this.addDecimal());
                    } else if (/[0-9]/.test(btn.textContent)) {
                        btn.addEventListener('click', () => this.addNumber(btn.textContent));
                    }
                });
            }

            addNumber(num) {
                if (this.newNumber) {
                    this.current = num;
                    this.newNumber = false;
                } else {
                    this.current += num;
                }
                this.display.value = this.current;
            }

            addDecimal() {
                if (!this.current.includes('.')) {
                    this.current += '.';
                    this.display.value = this.current;
                }
            }

            setOperation(op) {
                if (this.operation && !this.newNumber) {
                    this.calculate();
                }
                this.previous = this.current;
                this.operation = op;
                this.newNumber = true;
            }

            calculate() {
                if (!this.operation || this.newNumber) return;
                
                const a = parseFloat(this.previous);
                const b = parseFloat(this.current);
                let result;

                switch(this.operation) {
                    case '+': result = a + b; break;
                    case '-': result = a - b; break;
                    case '*': result = a * b; break;
                    case '/': result = a / b; break;
                    default: return;
                }

                this.current = result.toString();
                this.display.value = this.current;
                this.operation = null;
                this.newNumber = true;
            }

            clear() {
                this.current = '0';
                this.previous = '';
                this.operation = null;
                this.newNumber = true;
                this.display.value = '0';
            }

            backspace() {
                if (this.current.length > 1) {
                    this.current = this.current.slice(0, -1);
                } else {
                    this.current = '0';
                }
                this.display.value = this.current;
            }
        }

        class NotepadApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.textarea = windowEl.querySelector('.notepad-textarea');
                this.title = windowEl.querySelector('.window-title');
                // use title as filename if available
                this.filename = (this.title && this.title.textContent) ? this.title.textContent : 'Untitled.txt';
                this.setupHandlers();
                this.loadFile();
            }

            setupHandlers() {
                const buttons = this.windowEl.querySelectorAll('.notepad-btn');
                buttons.forEach(btn => {
                    const action = btn.dataset.action;
                    btn.addEventListener('click', () => {
                        if (action === 'new') this.newFile();
                        else if (action === 'save') this.saveFile();
                        else if (action === 'open') this.openFile();
                    });
                });
            }

            newFile() {
                if (this.textarea.value && !confirm('Discard changes?')) return;
                this.textarea.value = '';
                this.filename = 'Untitled.txt';
                this.title.textContent = this.filename;
            }

            saveFile() {
                // store in filesystem tree
                saveFileAtPath(this.filename, this.textarea.value);
                alert('File saved as ' + this.filename);
            }

            openFile() {
                const name = prompt('Filename to open (path allowed):', 'notes.txt');
                if (!name) return;
                const content = readFileAtPath(name) || '';
                this.textarea.value = content;
                this.filename = name;
                if (this.title) this.title.textContent = name;
            }

            loadFile() {
                const key = 'notepad_' + (this.filename || 'Untitled.txt');
                const saved = localStorage.getItem(key);
                if (saved) this.textarea.value = saved;
            }
        }

        class PaintApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.canvas = windowEl.querySelector('#paint-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.isDrawing = false;
                this.setupHandlers();
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            setupHandlers() {
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                const colorInput = this.windowEl.querySelector('#paint-color');
                if (colorInput) {
                    colorInput.addEventListener('change', (e) => {
                        this.ctx.strokeStyle = e.target.value;
                        this.ctx.fillStyle = e.target.value;
                    });
                }

                const sizeInput = this.windowEl.querySelector('#paint-size');
                if (sizeInput) {
                    sizeInput.addEventListener('change', (e) => {
                        this.ctx.lineWidth = e.target.value;
                    });
                }

                const clearBtn = this.windowEl.querySelector('.paint-clear-btn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    });
                }

                this.ctx.strokeStyle = '#000000';
                this.ctx.fillStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
            }

            startDrawing(e) {
                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
            }

            draw(e) {
                if (!this.isDrawing) return;
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
            }

            stopDrawing() {
                this.isDrawing = false;
                this.ctx.closePath();
            }
        }

        class TaskManagerApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.render();
                setInterval(() => this.render(), 2000);
            }

            render() {
                const area = this.windowEl.querySelector('.taskmgr-area');
                if (!area) return;

                const processes = [
                    {name: 'explorer.exe', cpu: 2, memory: 45},
                    {name: 'notepad.exe', cpu: 1, memory: 8},
                    {name: 'solitaire.exe', cpu: 3, memory: 12},
                    {name: 'cmd.exe', cpu: 0, memory: 4},
                    {name: 'winlogon.exe', cpu: 1, memory: 6}
                ];

                let html = '<table style="width: 100%; border-collapse: collapse;"><tr style="background: #000080; color: #fff;"><td style="border: 1px solid #000; padding: 5px;"><strong>Image Name</strong></td><td style="border: 1px solid #000; padding: 5px;"><strong>CPU %</strong></td><td style="border: 1px solid #000; padding: 5px;"><strong>Memory (MB)</strong></td></tr>';

                processes.forEach((p, i) => {
                    html += `<tr style="background: ${i % 2 === 0 ? '#ffffff' : '#c0c0c0'};"><td style="border: 1px solid #000; padding: 5px;">${p.name}</td><td style="border: 1px solid #000; padding: 5px;">${p.cpu}%</td><td style="border: 1px solid #000; padding: 5px;">${p.memory}</td></tr>`;
                });

                html += '</table>';
                area.innerHTML = html;
            }
        }

        class BrowserApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.history = ['about:home'];
                this.currentIndex = 0;
                this.setupHandlers();
                this.renderPage();
            }

            setupHandlers() {
                const backBtn = this.windowEl.querySelector('.browser-back-btn');
                const addressBar = this.windowEl.querySelector('.browser-address');
                const goBtn = this.windowEl.querySelector('.browser-go-btn');

                if (backBtn) backBtn.addEventListener('click', () => this.goBack());
                if (addressBar && goBtn) {
                    goBtn.addEventListener('click', () => this.navigate(addressBar.value));
                    addressBar.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.navigate(addressBar.value);
                    });
                }
            }

            navigate(url) {
                this.history = this.history.slice(0, this.currentIndex + 1);
                this.history.push(url);
                this.currentIndex++;
                this.renderPage();
            }

            goBack() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderPage();
                }
            }

            renderPage() {
                const url = this.history[this.currentIndex];
                const addressBar = this.windowEl.querySelector('.browser-address');
                if (addressBar) addressBar.value = url;

                let content = '<div style="padding: 20px;"><p style="color: #ff0000;">404 - Page Not Found</p></div>';

                if (url === 'about:home') {
                    content = '<div style="padding: 20px;"><h1>Welcome to Windows 95 Browser</h1><p>This is a simulated web browser.</p></div>';
                } else if (url === 'about:credits') {
                    content = '<div style="padding: 20px;"><h1>Credits</h1><p>Created by Will Hatch</p><p>Portfolio Website 2024</p></div>';
                } else if (url === 'about:nostalgia') {
                    content = '<div style="padding: 20px;"><h1>Windows 95 Nostalgia</h1><p>Remember the good old days?</p><p style="color: #0000ff; text-decoration: underline;">Click here to explore</p></div>';
                }

                const contentArea = this.windowEl.querySelector('.browser-content');
                if (contentArea) contentArea.innerHTML = content;
            }
        }

        // ============= ENHANCED FILE SYSTEM WITH 20+ APPLICATIONS =============
        // filesystem is hierarchical; we persist it to localStorage so user changes survive reloads.
        function loadFileSystem() {
            const saved = localStorage.getItem('fs');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('failed to parse saved filesystem', e);
                }
            }
            return null;
        }

        function saveFileSystem() {
            try {
                localStorage.setItem('fs', JSON.stringify(fileSystem));
            } catch (e) {
                console.error('failed to save filesystem', e);
            }
        }

        function ensureFolder(path) {
            const parts = path.split('/').filter(p => p);
            let node = fileSystem;
            for (const p of parts) {
                if (!node.folders) node.folders = {};
                if (!node.folders[p]) node.folders[p] = { files: {}, folders: {} };
                node = node.folders[p];
            }
            return node;
        }

        function getFolder(path) {
            if (!path) return fileSystem;
            const parts = path.split('/').filter(p => p);
            let node = fileSystem;
            for (const p of parts) {
                if (!node.folders || !node.folders[p]) return undefined;
                node = node.folders[p];
            }
            return node;
        }

        function saveFileAtPath(path, content) {
            const idx = path.lastIndexOf('/');
            const filename = idx >= 0 ? path.slice(idx + 1) : path;
            const folderpath = idx >= 0 ? path.slice(0, idx) : '';
            const folder = ensureFolder(folderpath);
            folder.files[filename] = { type: 'text', icon: 'document', content };
            saveFileSystem();
        }

        function readFileAtPath(path) {
            const idx = path.lastIndexOf('/');
            const filename = idx >= 0 ? path.slice(idx + 1) : path;
            const folderpath = idx >= 0 ? path.slice(0, idx) : '';
            const folder = getFolder(folderpath);
            if (folder && folder.files && folder.files[filename]) {
                return folder.files[filename].content;
            }
            return '';
        }

        function deletePath(path) {
            const idx = path.lastIndexOf('/');
            const filename = idx >= 0 ? path.slice(idx + 1) : path;
            const folderpath = idx >= 0 ? path.slice(0, idx) : '';
            const folder = getFolder(folderpath);
            if (!folder) return;
            if (folder.files && folder.files[filename]) {
                delete folder.files[filename];
            } else if (folder.folders && folder.folders[filename]) {
                delete folder.folders[filename];
            }
            saveFileSystem();
        }

        // clipboard for copy/paste operations
        let clipboard = null; // { path:string, type:'file'|'folder' }

        function renamePath(oldPath, newPath) {
            if (oldPath === newPath) return;
            const content = readFileAtPath(oldPath);
            if (content === '' && oldPath !== newPath) {
                // folder rename or move
                const idxOld = oldPath.lastIndexOf('/');
                const idxNew = newPath.lastIndexOf('/');
                const oldName = idxOld >= 0 ? oldPath.slice(idxOld+1) : oldPath;
                const newName = idxNew >= 0 ? newPath.slice(idxNew+1) : newPath;
                const parentOld = getFolder(idxOld>=0? oldPath.slice(0,idxOld): '');
                const parentNew = getFolder(idxNew>=0? newPath.slice(0,idxNew): '') || ensureFolder(idxNew>=0? newPath.slice(0,idxNew): '');
                if (parentOld && parentOld.folders && parentOld.folders[oldName]) {
                    parentNew.folders[newName] = parentOld.folders[oldName];
                    delete parentOld.folders[oldName];
                    saveFileSystem();
                }
            } else {
                // file rename/move
                saveFileAtPath(newPath, content);
                deletePath(oldPath);
            }
        }

        // deep copy one path to another location
        function copyPath(srcPath, destPath) {
            const idx = srcPath.lastIndexOf('/');
            const name = idx >= 0 ? srcPath.slice(idx + 1) : srcPath;
            const folderpath = idx >= 0 ? srcPath.slice(0, idx) : '';
            const folder = getFolder(folderpath);
            if (!folder) return;
            if (folder.files && folder.files[name]) {
                // file copy
                const content = folder.files[name].content;
                saveFileAtPath(destPath, content);
            } else if (folder.folders && folder.folders[name]) {
                // folder copy (deep clone)
                const node = folder.folders[name];
                const clone = JSON.parse(JSON.stringify(node));
                const idxDest = destPath.lastIndexOf('/');
                const destFolderPath = idxDest >= 0 ? destPath.slice(0, idxDest) : '';
                const destParent = getFolder(destFolderPath) || ensureFolder(destFolderPath);
                const newName = idxDest >= 0 ? destPath.slice(idxDest + 1) : destPath;
                destParent.folders[newName] = clone;
                saveFileSystem();
            }
        }

        // build or load the filesystem
        let fileSystem = loadFileSystem();
        if (!fileSystem) {
            fileSystem = {
            files: {
                'About.txt': {
                    type: 'text',
                    icon: 'document',
                    content: `Will Hatch - About Me\n=====================================\n\nWill Hatch is a junior at Berklee College of Music, specializing in hip-hop and electronic music production.\n\nCurrently active as:\n• vvill - Solo music producer\n• Connxtion - Group producer and collaborator\n\nBased in Boston, MA`
                },
                'Purpose.txt': {
                    type: 'text',
                    icon: 'document',
                    content: `Release Planner Tool\n=====================================\nStatus: In Development\n\nThis tool helps independent artists organize release timelines, marketing plans, and distribution strategies.`
                },
                'Links.url': {
                    type: 'url',
                    icon: 'link',
                    content: `Important Links\n=====================================\n\nMusic: Apple Music, Spotify, Bandcamp\nSocial: Instagram (@vvill, @connxtion)\nEmail: willhatch@berklee.edu`
                }
            },
            folders: {
                'Program Files': {
                    icon: 'programfolder',
                    files: {
                        'Internet Explorer.exe': { type: 'app', icon: 'ie', appType: 'ie', content: 'Internet Explorer' },
                        'Netscape.exe': { type: 'app', icon: 'netscape', appType: 'netscape', content: 'Netscape Navigator' },
                        'Winamp.exe': { type: 'app', icon: 'winamp', appType: 'winamp', content: 'Winamp Music Player' },
                        'mIRC.exe': { type: 'app', icon: 'mirc', appType: 'mirc', content: 'mIRC Chat Client' },
                        'AIM.exe': { type: 'app', icon: 'aim', appType: 'aim', content: 'AOL Instant Messenger' }
                    },
                    folders: {
                        'Accessories': {
                            icon: 'folder',
                            files: {
                                'Notepad.exe': { type: 'app', icon: 'notepad', appType: 'notepad', content: 'Simple Text Editor' },
                                'Paint.exe': { type: 'app', icon: 'paint', appType: 'paint', content: 'Paint Application' },
                                'Calculator.exe': { type: 'app', icon: 'calculator', appType: 'calculator', content: 'Basic Calculator' },
                                'WordPad.exe': { type: 'app', icon: 'wordpad', appType: 'wordpad', content: 'Word Processor' }
                            }
                        }
                    }
                },
                'System Utilities': {
                    icon: 'utilfolder',
                    files: {
                        'Device Manager.exe': { type: 'app', icon: 'devicemgr', appType: 'devicemgr', content: 'Device Manager' },
                        'Task Manager.exe': { type: 'app', icon: 'taskmgr', appType: 'taskmgr', content: 'Task Manager' },
                        'Registry Editor.exe': { type: 'app', icon: 'regedit', appType: 'regedit', content: 'Registry Editor' },
                        'System Monitor.exe': { type: 'app', icon: 'sysmon', appType: 'sysmon', content: 'System Monitor' }
                    }
                },
                'Viruses': {
                    icon: 'viralfolder',
                    files: {
                        'MEMZ.exe': { type: 'app', icon: 'virus', appType: 'memz', content: 'Malware Simulator' },
                        'Badware.exe': { type: 'app', icon: 'virus', appType: 'virus', content: 'Virus Simulator' },
                        'CoolPatch.exe': { type: 'app', icon: 'virus', appType: 'patch', content: 'Fake Security Patch' }
                    }
                },
                'Windows': {
                    icon: 'windowsfolder',
                    files: {
                        'System.ini': { type: 'text', icon: 'textfile', content: '[boot]\nshell=explorer.exe\ndevice=vga.drv' },
                        'Win.ini': { type: 'text', icon: 'textfile', content: '[Windows]\nload=\nrun=\n[Desktop]\nWallpaper=' },
                        'Config.sys': { type: 'text', icon: 'textfile', content: 'device=himem.sys\ndevice=emm386.exe\nshell=command.com' }
                    },
                    folders: {
                        'System32': {
                            icon: 'folder',
                            files: {
                                'kernel32.dll': { type: 'text', icon: 'dll', content: 'Windows Kernel Library' },
                                'user32.dll': { type: 'text', icon: 'dll', content: 'User Interface Library' },
                                'gdi32.dll': { type: 'text', icon: 'dll', content: 'Graphics Device Interface' },
                                'shell32.dll': { type: 'text', icon: 'dll', content: 'Shell Library' },
                                'ntdll.dll': { type: 'text', icon: 'dll', content: 'Native API Library' }
                            }
                        },
                        'Drivers': {
                            icon: 'folder',
                            files: {
                                'vga.drv': { type: 'text', icon: 'driver', content: 'VGA Display Driver' },
                                'mouse.drv': { type: 'text', icon: 'driver', content: 'Mouse Driver' },
                                'kbd.drv': { type: 'text', icon: 'driver', content: 'Keyboard Driver' },
                                'serial.drv': { type: 'text', icon: 'driver', content: 'Serial Port Driver' }
                            }
                        }
                    }
                },
                'My Documents': {
                    icon: 'docfolder',
                    files: {
                        'Resume.doc': { type: 'text', icon: 'document', content: 'Will Hatch Resume - Audio Engineering & Production' },
                        'Music Notes.txt': { type: 'text', icon: 'document', content: 'Production Notes\n- Work on beat patterns\n- Improve mixing skills\n- Collaborate with Connxtion' }
                    }
                },
                'My Music': {
                    icon: 'musicfolder',
                    files: {
                        'vvill - Track 01.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' },
                        'vvill - Track 02.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' },
                        'Connxtion - Collab.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' }
                    }
                }
            }
        };

        // ============= WINDOW MANAGER (Enhanced) =============
        class WindowManager {
            constructor() {
                this.windows = [];
                this.zIndex = 1000;
                this.container = document.getElementById('windows-container');
                this.taskbarWindows = document.getElementById('taskbar-windows');
                this.appStates = {}; // Store app states
            }

            getIconSVG(iconType) {
                const icons = {
                    document: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 2 0 L 2 14 L 12 14 L 12 4 L 8 0 Z" fill="#ffffff" stroke="#000" stroke-width="0.5"/><path d="M 8 0 L 12 4 L 8 4 Z" fill="#e0e0e0"/></svg>`,
                    folder: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 1 3 L 1 14 L 15 14 L 15 4 L 8 4 L 6 2 L 1 2 Z" fill="#ffcc00" stroke="#000" stroke-width="0.5"/></svg>`,
                    executable: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="1" y="1" width="14" height="12" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/><rect x="2" y="2" width="12" height="2" fill="#000080"/></svg>`,
                    dll: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="2" y="1" width="12" height="13" fill="#ffccff" stroke="#000" stroke-width="0.5"/><text x="8" y="10" font-size="6" text-anchor="middle" fill="#000">DLL</text></svg>`,
                    driver: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="2" y="2" width="12" height="11" fill="#ccccff" stroke="#000" stroke-width="0.5"/></svg>`,
                    virus: `<svg viewBox="0 0 16 16" width="16" height="16"><circle cx="8" cy="8" r="5" fill="#ff0000" stroke="#000" stroke-width="0.5"/><circle cx="8" cy="8" r="3" fill="none" stroke="#ff0000" stroke-width="0.5"/></svg>`,
                    link: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 3 8 Q 3 3 8 3 Q 13 3 13 8" fill="none" stroke="#0000ff" stroke-width="1"/><path d="M 3 8 Q 3 13 8 13 Q 13 13 13 8" fill="none" stroke="#0000ff" stroke-width="1"/></svg>`
                };
                return icons[iconType] || icons.document;
            }

            openFile(filename, fromFolder = null) {
                const existingWindow = this.windows.find(w => w.filename === filename && w.folder === fromFolder);
                if (existingWindow) {
                    existingWindow.element.style.zIndex = ++this.zIndex;
                    existingWindow.element.classList.remove('minimized');
                    return;
                }

                // compute full path
                const fullPath = fromFolder ? `${fromFolder}/${filename}` : filename;
                let fileData;
                if (fromFolder) {
                    const folder = getFolder(fromFolder);
                    fileData = folder && folder.files ? folder.files[filename] : null;
                } else {
                    fileData = fileSystem.files[filename];
                }

                if (!fileData) return;

                // Handle app files
                if (fileData.type === 'app') {
                    this.openApplication(fileData.appType, filename);
                    return;
                }

                // open text file in notepad for editing
                const content = readFileAtPath(fullPath) || fileData.content || '';
                this.openApplication('notepad', fullPath, content);
            }

            openApplication(appType, appName, initialContent) {
                const existingWindow = this.windows.find(w => w.appType === appType);
                if (existingWindow) {
                    existingWindow.element.style.zIndex = ++this.zIndex;
                    existingWindow.element.classList.remove('minimized');
                    return existingWindow.element;
                }

                const windowId = `window-${this.windows.length}`;
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                
                let content = '';
                let appInstance = null;

                switch(appType) {
                    case 'calculator':
                        window.style.width = '280px';
                        content = `<div class="calc-app" style="padding: 10px;">
                            <input type="text" id="calc-display" style="width: 100%; margin-bottom: 10px; padding: 5px; border: 2px inset; font-size: 14px;" value="0" readonly>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                                <button class="calc-btn">C</button><button class="calc-btn">←</button><button class="calc-btn">/</button><button class="calc-btn">*</button>
                                <button class="calc-btn">7</button><button class="calc-btn">8</button><button class="calc-btn">9</button><button class="calc-btn">-</button>
                                <button class="calc-btn">4</button><button class="calc-btn">5</button><button class="calc-btn">6</button><button class="calc-btn">+</button>
                                <button class="calc-btn">1</button><button class="calc-btn">2</button><button class="calc-btn">3</button><button class="calc-btn">.</button>
                                <button class="calc-btn" style="grid-column: 1 / 3;">0</button><button class="calc-btn" style="grid-column: 3 / 5;">=</button>
                            </div>
                        </div>`;
                        break;

                    case 'notepad':
                        window.style.width = '600px';
                        window.style.height = '400px';
                        content = `<div class="notepad-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; display: flex; gap: 5px;">
                                <button class="notepad-btn" data-action="new">New</button>
                                <button class="notepad-btn" data-action="open">Open</button>
                                <button class="notepad-btn" data-action="save">Save</button>
                            </div>
                            <textarea class="notepad-textarea" style="flex: 1; border: 1px inset; padding: 5px; font-family: Courier; resize: none;"></textarea>
                        </div>`;
                        break;

                    case 'paint':
                        window.style.width = '640px';
                        window.style.height = '500px';
                        content = `<div class="paint-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; display: flex; gap: 10px; align-items: center;">
                                <label>Color: <input type="color" id="paint-color" value="#000000"></label>
                                <label>Size: <input type="range" id="paint-size" min="1" max="20" value="2" style="width: 100px;"></label>
                                <button class="paint-clear-btn" style="padding: 3px 10px;">Clear</button>
                            </div>
                            <canvas id="paint-canvas" width="640" height="450" style="border: 1px inset; background: white; cursor: crosshair; flex: 1;"></canvas>
                        </div>`;
                        break;











                    case 'taskmgr':
                        window.style.width = '600px';
                        window.style.height = '400px';
                        content = `<div class="taskmgr-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 10px; border-bottom: 1px solid #000;">
                                <button style="padding: 3px 10px;">Refresh</button>
                            </div>
                            <div class="taskmgr-area" style="flex: 1; overflow-y: auto; padding: 5px; font-size: 11px;"></div>
                        </div>`;
                        break;

                    case 'ie':
                        window.style.width = '700px';
                        window.style.height = '500px';
                        content = `<div class="browser-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; background: #c0c0c0; display: flex; gap: 5px;">
                                <button class="browser-back-btn" style="width: 50px;">← Back</button>
                                <input type="text" class="browser-address" style="flex: 1; padding: 3px;" value="about:home">
                                <button class="browser-go-btn" style="width: 50px;">Go</button>
                            </div>
                            <div class="browser-content" style="flex: 1; background: #ffffff; overflow-y: auto;"></div>
                        </div>`;
                        break;



                    default:
                        content = `<div style="padding: 10px;"><p>Application: ${appName}</p><p>Not implemented</p></div>`;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${appName}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        ${content}
                    </div>
                `;

                this.container.appendChild(window);

                const windowObj = {
                    filename: appName,
                    appType: appType,
                    element: window
                };

                this.windows.push(windowObj);
                this.addTaskbarButton(appName, windowObj);
                this.makeWindowDraggable(window);
                window.style.zIndex = ++this.zIndex;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                // Initialize app classes
                setTimeout(() => {
                        if (appType === 'calculator') appInstance = new CalculatorApp(window);
                        else if (appType === 'notepad') {
                            appInstance = new NotepadApp(window);
                            if (initialContent && appInstance.textarea) {
                                appInstance.textarea.value = initialContent;
                                // update storage too
                                appInstance.filename = appName || appInstance.filename;
                                appInstance.title.textContent = appInstance.filename;
                            }
                        }
                        else if (appType === 'paint') appInstance = new PaintApp(window);

                        else if (appType === 'taskmgr') appInstance = new TaskManagerApp(window);
                        else if (appType === 'ie') appInstance = new BrowserApp(window);

                    }, 100);
            }

            generateVirusWindow(type) {
                if (type === 'memz') {
                    return `<div style="background: #000; color: #0f0; padding: 10px; font-family: Courier; height: 250px; overflow-y: auto; animation: flicker 0.15s;"><p>MEMZ.exe - Memory Corruption Detected</p><p style="animation: glitch 0.2s infinite;">System files corrupted...</p><p>⚠ WARNING: System Integrity Check Failed</p><p style="color: #f00;">CRITICAL ERROR</p></div>`;
                } else if (type === 'virus') {
                    return `<div style="padding: 10px;"><p style="color: #ff0000; font-weight: bold;">⚠ VIRUS DETECTED</p><p>File: BADWARE.EXE</p><p>Status: <span style="color: #ff0000;">INFECTED</span></p><p>Action: Quarantine / Delete / Ignore</p><button onclick="alert('Action not available')">Scan Now</button></div>`;
                } else {
                    return `<div style="padding: 10px;"><p><strong>Windows Security Update</strong></p><p>Downloading: CoolPatch v1.0</p><div style="width: 300px; height: 20px; border: 1px solid #000; margin: 10px 0;"><div style="width: 45%; height: 100%; background: #0080ff;"></div></div><p>45% Complete</p><button onclick="alert('Update starting...')">Install Update</button></div>`;
                }
            }

            openFolder(folderName) {
                const folder = getFolder(folderName);
                if (!folder) return;
                // reuse openFolderPath for navigation
                this.openFolderPath(folderName, folder);
            }

            createWindowElement(filename, fileData, fromFolder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${filename}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="file-viewer">
                            <pre>${this.escapeHtml(fileData.content)}</pre>
                        </div>
                    </div>
                `;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                return window;
            }

            createFolderWindow(folderName, folder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                window.style.width = '500px';
                window.style.minHeight = '300px';

                let itemsHtml = '';
                
                // Add subfolders
                if (folder.folders) {
                    for (const [subfolderName, subfolder] of Object.entries(folder.folders)) {
                        itemsHtml += `
                            <div class="folder-item" data-folder="${subfolderName}" data-type="folder">
                                <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                                </svg>
                                <div class="folder-name">${subfolderName}</div>
                            </div>
                        `;
                    }
                }

                // Add files
                for (const [filename, fileData] of Object.entries(folder.files)) {
                    itemsHtml += `
                        <div class="folder-item" data-file="${filename}" data-path="${folderName}/${filename}" data-folder="${folderName}" data-type="file">
                            <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                                <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                            </svg>
                            <div class="folder-name">${filename}</div>
                        </div>
                    `;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${folderName}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="folder-viewer">
                            ${itemsHtml}
                        </div>
                    </div>
                `;

                // Add click handlers
                window.querySelectorAll('.folder-item').forEach(item => {
                    const isFolder = item.dataset.type === 'folder';
                    const name = isFolder ? item.dataset.folder : item.dataset.file;
                    const fromFolder = item.dataset.folder;

                    item.addEventListener('dblclick', () => {
                        if (isFolder) {
                            const subfolder = fileSystem.folders[folderName].folders[name];
                            this.openFolderPath(folderName + '/' + name, subfolder);
                        } else {
                            this.openFile(name, folderName);
                        }
                    });
                });

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                return window;
            }

            openFolderPath(path, folder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                window.style.width = '500px';
                window.style.minHeight = '300px';
                // keep track of the current path for context menus
                window.dataset.folderPath = path;

                let itemsHtml = '';
                
                if (folder.folders) {
                    for (const [subfolderName, subfolder] of Object.entries(folder.folders)) {
                        itemsHtml += `
                            <div class="folder-item" data-folder="${subfolderName}" data-type="folder">
                                <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                                </svg>
                                <div class="folder-name">${subfolderName}</div>
                            </div>
                        `;
                    }
                }

                for (const [filename, fileData] of Object.entries(folder.files)) {
                    itemsHtml += `
                        <div class="folder-item" data-file="${filename}" data-path="${path}/${filename}" data-type="file">
                            <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                                <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                            </svg>
                            <div class="folder-name">${filename}</div>
                        </div>
                    `;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${path}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div style="padding:5px;">
                            <button class="new-folder-btn" style="margin-right:5px;">New Folder</button>
                            <button class="new-file-btn">New File</button>
                        </div>
                        <div class="folder-viewer">
                            ${itemsHtml}
                        </div>
                    </div>
                `;

                this.container.appendChild(window);

                // clicking / double-click handlers as before, plus context menu and drag/drop support
                window.querySelectorAll('.folder-item').forEach(item => {
                    const isFolder = item.dataset.type === 'folder';
                    const name = isFolder ? item.dataset.folder : item.dataset.file;
                    const parentPath = path;
                    const fullPath = parentPath ? parentPath + '/' + name : name;

                    // make draggable
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', fullPath);
                    });

                    item.addEventListener('dblclick', () => {
                        if (isFolder) {
                            const subfolder = folder.folders[name];
                            this.openFolderPath(path + '/' + name, subfolder);
                        } else {
                            const fileData = folder.files[name];
                            if (fileData.type === 'app') {
                                this.openApplication(fileData.appType, name);
                            } else {
                                const content = fileData.content || '';
                                this.openApplication('notepad', fullPath, content);
                            }
                        }
                    });

                    // handle dragover/drop onto folders
                    item.addEventListener('dragover', (e) => {
                        if (isFolder) e.preventDefault();
                    });
                    item.addEventListener('drop', (e) => {
                        if (!isFolder) return;
                        e.preventDefault();
                        const src = e.dataTransfer.getData('text/plain');
                        if (!src) return;
                        const destFolder = parentPath ? parentPath + '/' + name : name;
                        const movingName = src.split('/').pop();
                        const dest = destFolder + '/' + movingName;
                        renamePath(src, dest);
                        // refresh current view
                        windowManager.closeWindow(windowId);
                        const folderNode = getFolder(parentPath);
                        windowManager.openFolderPath(parentPath, folderNode);
                    });

                    // right-click menu for rename/delete/copy
                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        const menuItems = [];
                        if (isFolder && clipboard) {
                            menuItems.push({ label: 'Paste', action: () => {
                                    const name2 = clipboard.path.split('/').pop();
                                    const dest = fullPath + '/' + name2;
                                    copyPath(clipboard.path, dest);
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(parentPath);
                                    windowManager.openFolderPath(parentPath, folderNode);
                                }
                            });
                        }
                        menuItems.push({ label: 'Copy', action: () => {
                                clipboard = { path: fullPath, type: isFolder ? 'folder' : 'file' };
                            }
                        });
                        menuItems.push({ label: 'Rename', action: () => {
                                const newName = prompt('New name:', name);
                                if (newName && newName !== name) {
                                    const newPath = parentPath ? parentPath + '/' + newName : newName;
                                    renamePath(fullPath, newPath);
                                    // refresh the view
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(parentPath);
                                    windowManager.openFolderPath(parentPath, folderNode);
                                }
                            }
                        });
                        menuItems.push({ label: 'Delete', action: () => {
                                if (confirm(`Delete ${fullPath}?`)) {
                                    deletePath(fullPath);
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(parentPath);
                                    windowManager.openFolderPath(parentPath, folderNode);
                                }
                            }
                        });
                        showContextMenu(e.clientX, e.clientY, menuItems);
                    });
                });

                // drag over / drop into empty space viewer
                const viewer = window.querySelector('.folder-viewer');
                if (viewer) {
                    viewer.addEventListener('dragover', (e) => { e.preventDefault(); });
                    viewer.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const src = e.dataTransfer.getData('text/plain');
                        if (!src) return;
                        const movingName = src.split('/').pop();
                        const dest = path ? path + '/' + movingName : movingName;
                        renamePath(src, dest);
                        windowManager.closeWindow(windowId);
                        const folderNode = getFolder(path);
                        windowManager.openFolderPath(path, folderNode);
                    });

                    viewer.addEventListener('contextmenu', (e) => {
                        if (e.target.closest('.folder-item')) return; // handled above
                        e.preventDefault();
                        const items = [];
                        if (clipboard) {
                            items.push({ label: 'Paste', action: () => {
                                    const name2 = clipboard.path.split('/').pop();
                                    const dest = path ? path + '/' + name2 : name2;
                                    copyPath(clipboard.path, dest);
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(path);
                                    windowManager.openFolderPath(path, folderNode);
                                }
                            });
                        }
                        items.push({ label: 'New Folder', action: () => {
                                const name = prompt('Folder name:');
                                if (name) {
                                    const full = path ? path + '/' + name : name;
                                    ensureFolder(full);
                                    saveFileSystem();
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(path);
                                    windowManager.openFolderPath(path, folderNode);
                                }
                            }
                        });
                        items.push({ label: 'New File', action: () => {
                                const name = prompt('File name:');
                                if (name) {
                                    const full = path ? path + '/' + name : name;
                                    saveFileAtPath(full, '');
                                    windowManager.closeWindow(windowId);
                                    const folderNode = getFolder(path);
                                    windowManager.openFolderPath(path, folderNode);
                                }
                            }
                        });
                        showContextMenu(e.clientX, e.clientY, items);
                    });
                }



                const windowObj = { filename: path, folder: path, element: window };
                this.windows.push(windowObj);
                this.addTaskbarButton(path.split('/').pop(), windowObj);
                this.makeWindowDraggable(window);
                window.style.zIndex = ++this.zIndex;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                // new folder/file buttons
                const newFolderBtn = window.querySelector('.new-folder-btn');
                if (newFolderBtn) {
                    newFolderBtn.addEventListener('click', () => {
                        const name = prompt('Folder name:');
                        if (name) {
                            const f = ensureFolder(path + '/' + name);
                            saveFileSystem();
                            // refresh window
                            this.closeWindow(windowId);
                            const folderNode = getFolder(path);
                            this.openFolderPath(path, folderNode);
                        }
                    });
                }
                const newFileBtn = window.querySelector('.new-file-btn');
                if (newFileBtn) {
                    newFileBtn.addEventListener('click', () => {
                        const name = prompt('File name:');
                        if (name) {
                            const full = path ? path + '/' + name : name;
                            saveFileAtPath(full, '');
                            this.closeWindow(windowId);
                            const folderNode = getFolder(path);
                            this.openFolderPath(path, folderNode);
                        }
                    });
                }
            }

            makeWindowDraggable(windowElement) {
                const titlebar = windowElement.querySelector('.window-titlebar');
                let offsetX = 0;
                let offsetY = 0;
                let isDragging = false;

                titlebar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - windowElement.offsetLeft;
                    offsetY = e.clientY - windowElement.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        windowElement.style.left = (e.clientX - offsetX) + 'px';
                        windowElement.style.top = (e.clientY - offsetY) + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                windowElement.addEventListener('mousedown', () => {
                    windowElement.style.zIndex = ++this.zIndex;
                });
            }

            minimizeWindow(windowId) {
                const window = document.getElementById(windowId);
                window.classList.toggle('minimized');
            }

            closeWindow(windowId) {
                const window = document.getElementById(windowId);
                const windowObj = this.windows.find(w => w.element.id === windowId);
                
                if (windowObj) {
                    this.windows = this.windows.filter(w => w !== windowObj);
                }

                const taskbarBtn = document.querySelector(`[data-window-id="${windowId}"]`);
                if (taskbarBtn) taskbarBtn.remove();

                window.remove();
            }

            addTaskbarButton(filename, windowObj) {
                const btn = document.createElement('button');
                btn.className = 'taskbar-window-btn';
                btn.dataset.windowId = windowObj.element.id;
                btn.textContent = filename;
                
                btn.addEventListener('click', () => {
                    const isMinimized = windowObj.element.classList.contains('minimized');
                    if (isMinimized) {
                        windowObj.element.classList.remove('minimized');
                        windowObj.element.style.zIndex = ++this.zIndex;
                    } else {
                        windowObj.element.classList.add('minimized');
                    }
                });

                this.taskbarWindows.appendChild(btn);
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
        }

        // ============= INITIALIZATION =============
        let windowManager;
        try {
            windowManager = new WindowManager();

            // Auto-open welcome notepad on page load with specific content
            setTimeout(() => {
                const welcomeText = `Welcome

welcome to misdorvevo.com. here i am developing some tools to assist indepedent artsits manage their career. feel free to click around my computer and try things out.

vv`;
            const win = windowManager.openApplication('notepad', 'Welcome.txt', welcomeText);
            if (win) {
                // position the window nicely after opening
                win.style.left = 'calc(50% - 400px)';
                win.style.top = '50%';
                win.style.transform = 'translateY(-50%)';
            }
        }, 100);

        // Desktop icon handlers
        const desktopIcons = document.querySelectorAll('.desktop-icon');
        const desktopContainer = document.querySelector('.desktop-icons');
        
        // track persisted desktop icon coordinates
        let desktopPositions = JSON.parse(localStorage.getItem('desktopPositions') || '{}');

        // right-click on empty desktop for quick new file/folder
        desktopContainer.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.desktop-icon')) return;
            e.preventDefault();
            const items = [];
            if (clipboard) {
                items.push({ label: 'Paste', action: () => {
                        const name = clipboard.path.split('/').pop();
                        const dest = name;
                        if (clipboard.type === 'file' || clipboard.type === 'folder') {
                            if (clipboard.type === 'file') {
                                copyPath(clipboard.path, dest);
                            } else {
                                copyPath(clipboard.path, dest);
                            }
                            location.reload();
                        }
                    }
                });
            }
            items.push({ label: 'New Folder', action: () => {
                        const name = prompt('Folder name:');
                        if (name) {
                            ensureFolder(name);
                            saveFileSystem();
                            location.reload();
                        }
                    }
                });
            items.push({ label: 'New File', action: () => {
                        const name = prompt('File name:');
                        if (name) {
                            saveFileAtPath(name, '');
                            location.reload();
                        }
                    }
                });
            showContextMenu(e.clientX, e.clientY, items);
        });

        // initialize positions and make absolute
        desktopIcons.forEach(icon => {
            const key = icon.dataset.file;
            icon.style.position = 'absolute';
            if (desktopPositions[key]) {
                icon.style.left = desktopPositions[key].x + 'px';
                icon.style.top = desktopPositions[key].y + 'px';
            } else {
                // compute current offset within container
                const rect = icon.getBoundingClientRect();
                const contRect = desktopContainer.getBoundingClientRect();
                const x = rect.left - contRect.left;
                const y = rect.top - contRect.top;
                desktopPositions[key] = {x,y};
                icon.style.left = x + 'px';
                icon.style.top = y + 'px';
            }
        });
        // persist initial layout
        localStorage.setItem('desktopPositions', JSON.stringify(desktopPositions));

        let draggedIcon = null;
        let dragStartX = 0;
        let dragStartY = 0;

        desktopIcons.forEach(icon => {
            // HTML5 drag support so items can be moved into folders
            icon.setAttribute('draggable', 'true');
            icon.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', icon.dataset.file);
            });

            icon.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                draggedIcon = icon;
                dragStartX = e.clientX - icon.offsetLeft;
                dragStartY = e.clientY - icon.offsetTop;
                icon.classList.add('dragging');
                icon.style.position = 'absolute';
            });

            icon.addEventListener('dblclick', () => {
                const file = icon.dataset.file;
                if (fileSystem.folders[file]) {
                    windowManager.openFolder(file);
                } else {
                    windowManager.openFile(file);
                }
            });

            icon.addEventListener('click', (e) => {
                if (e.detail === 1) {
                    if (!e.ctrlKey && !e.metaKey) {
                        desktopIcons.forEach(i => i.classList.remove('selected'));
                    }
                    icon.classList.toggle('selected');
                }
            });

            icon.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const name = icon.dataset.file;
                const isFolder = !!fileSystem.folders[name];
                showContextMenu(e.clientX, e.clientY, [
                    { label: 'Copy', action: () => {
                            clipboard = { path: name, type: isFolder ? 'folder' : 'file' };
                        }
                    },
                    { label: 'Rename', action: () => {
                            const newName = prompt('New name:', name);
                            if (newName && newName !== name) {
                                // preserve desktop coordinates
                                if (desktopPositions[name]) {
                                    desktopPositions[newName] = desktopPositions[name];
                                    delete desktopPositions[name];
                                    localStorage.setItem('desktopPositions', JSON.stringify(desktopPositions));
                                }
                                renamePath(name, newName);
                                location.reload();
                            }
                        }
                    },
                    { label: 'Delete', action: () => {
                            if (confirm(`Delete ${name}?`)) {
                                if (desktopPositions[name]) {
                                    delete desktopPositions[name];
                                    localStorage.setItem('desktopPositions', JSON.stringify(desktopPositions));
                                }
                                deletePath(name);
                                location.reload();
                            }
                        }
                    }
                ]);
            });
        });

        // helpers for showing/hiding the right-click menu
        function showContextMenu(x, y, items) {
            const menu = document.getElementById('context-menu');
            if (!menu) return;
            menu.innerHTML = '';
            items.forEach(i => {
                const el = document.createElement('div');
                el.textContent = i.label;
                el.addEventListener('click', () => {
                    i.action();
                    hideContextMenu();
                });
                menu.appendChild(el);
            });
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }
        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            if (menu) menu.style.display = 'none';
        }
        document.addEventListener('click', hideContextMenu);

        document.addEventListener('mousemove', (e) => {
            if (draggedIcon) {
                const x = e.clientX - dragStartX;
                const y = e.clientY - dragStartY;
                draggedIcon.style.left = x + 'px';
                draggedIcon.style.top = y + 'px';
            }
        });

        // allow dropping into desktop container (moves item to root)
        desktopContainer.addEventListener('dragover', (e) => { e.preventDefault(); });
        desktopContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const src = e.dataTransfer.getData('text/plain');
            if (!src) return;
            const name = src.split('/').pop();
            const dest = name; // root
            renamePath(src, dest);
            location.reload();
        });

        document.addEventListener('mouseup', () => {
            if (draggedIcon) {
                // persist position
                const key = draggedIcon.dataset.file;
                desktopPositions[key] = {
                    x: parseInt(draggedIcon.style.left,10) || 0,
                    y: parseInt(draggedIcon.style.top,10) || 0
                };
                localStorage.setItem('desktopPositions', JSON.stringify(desktopPositions));

                draggedIcon.classList.remove('dragging');
                draggedIcon = null;
            }
        });

        // Start button
        document.getElementById('start-button').addEventListener('click', () => {
            const startMenu = document.getElementById('start-menu');
            startMenu.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            const startMenu = document.getElementById('start-menu');
            const startButton = document.getElementById('start-button');
            if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
                startMenu.classList.remove('active');
            }
        });

        // System time
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('system-time').textContent = time;
        }
        updateTime();
        setInterval(updateTime, 1000);
        // end of initialization
        } catch (e) {
            alert('Initialization error: ' + e);
            console.error('Initialization error', e);
        }
    </script>
    <!-- right-click context menu -->
    <div id="context-menu" class="context-menu"></div>

</body>
</html>
