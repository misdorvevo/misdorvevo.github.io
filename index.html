<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will Hatch - Desktop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Desktop Environment -->
    <div class="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icons">
            <div class="desktop-icon" data-file="My Computer">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <rect x="2" y="3" width="20" height="13" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
                    <line x1="2" y1="3" x2="22" y2="3" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="2" y1="3" x2="2" y2="16" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="22" y1="3" x2="22" y2="16" stroke="#808080" stroke-width="1"/>
                    <line x1="2" y1="16" x2="22" y2="16" stroke="#808080" stroke-width="1"/>
                    <rect x="3" y="4" width="18" height="11" fill="#000080" stroke="#000" stroke-width="0.5"/>
                    <rect x="4" y="5" width="16" height="3" fill="#00aaff"/>
                    <rect x="4" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="7" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="10" y="9" width="2" height="2" fill="#ffff00"/>
                    <rect x="8" y="17" width="8" height="2" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/>
                    <rect x="11" y="19" width="2" height="2" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/>
                </svg>
                <div class="icon-label">My Computer</div>
            </div>
            <div class="desktop-icon" data-file="My Documents">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                    <rect x="5" y="9" width="5" height="7" fill="#ffffff" stroke="#000" stroke-width="0.5"/>
                    <line x1="5.5" y1="10" x2="9.5" y2="10" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="11" x2="9.5" y2="11" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="12" x2="9.5" y2="12" stroke="#000" stroke-width="0.3"/>
                    <line x1="5.5" y1="13" x2="8.5" y2="13" stroke="#000" stroke-width="0.3"/>
                    <rect x="11" y="10" width="5" height="6" fill="#ffffff" stroke="#000" stroke-width="0.5"/>
                    <line x1="11.5" y1="11" x2="15.5" y2="11" stroke="#000" stroke-width="0.3"/>
                    <line x1="11.5" y1="12" x2="15.5" y2="12" stroke="#000" stroke-width="0.3"/>
                    <line x1="11.5" y1="13" x2="14.5" y2="13" stroke="#000" stroke-width="0.3"/>
                </svg>
                <div class="icon-label">My Documents</div>
            </div>
            <div class="desktop-icon" data-file="Readme.txt">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                    <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                    <rect x="3" y="2" width="14" height="3" fill="#000080"/>
                    <text x="10" y="4" font-size="2" text-anchor="middle" fill="#ffffff" font-weight="bold">TXT</text>
                    <line x1="4" y1="7" x2="16" y2="7" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="8.5" x2="15" y2="8.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="10" x2="16" y2="10" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="11.5" x2="14" y2="11.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="13" x2="16" y2="13" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="14.5" x2="15" y2="14.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="16" x2="16" y2="16" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="17.5" x2="13" y2="17.5" stroke="#000" stroke-width="0.4"/>
                    <line x1="4" y1="19" x2="15" y2="19" stroke="#000" stroke-width="0.4"/>
                </svg>
                <div class="icon-label">Readme.txt</div>
            </div>
            <div class="desktop-icon" data-file="Games">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ff6b9d" stroke="#000" stroke-width="1"/>
                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ff99bb" stroke="none"/>
                    <circle cx="8" cy="12" r="2" fill="#ffff00"/>
                    <rect x="13" y="11" width="3" height="2" fill="#00ff00"/>
                    <rect x="13" y="14" width="3" height="2" fill="#0000ff"/>
                </svg>
                <div class="icon-label">Games</div>
            </div>
            <div class="desktop-icon" data-file="MineSweeper.exe">
                <svg class="icon-image" viewBox="0 0 24 24" width="32" height="32">
                    <rect x="1" y="1" width="22" height="22" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
                    <line x1="1" y1="1" x2="23" y2="1" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="1" y1="1" x2="1" y2="23" stroke="#dfdfdf" stroke-width="1"/>
                    <line x1="23" y1="1" x2="23" y2="23" stroke="#808080" stroke-width="1"/>
                    <line x1="1" y1="23" x2="23" y2="23" stroke="#808080" stroke-width="1"/>
                    <rect x="2" y="2" width="20" height="4" fill="#000080" stroke="#000" stroke-width="0.5"/>
                    <text x="12" y="4.5" font-size="2.5" text-anchor="middle" fill="#ffffff" font-weight="bold">MS</text>
                    <rect x="3" y="7" width="18" height="15" fill="#c0c0c0"/>
                    <g stroke="#000" stroke-width="0.3">
                        <rect x="4" y="8" width="2.5" height="2.5" fill="#999999"/>
                        <rect x="7" y="8" width="2.5" height="2.5" fill="#cccccc"/>
                        <rect x="10" y="8" width="2.5" height="2.5" fill="#999999"/>
                        <rect x="13" y="8" width="2.5" height="2.5" fill="#ff6666"/>
                        <rect x="16" y="8" width="2.5" height="2.5" fill="#66ff66"/>
                        <rect x="4" y="11.5" width="2.5" height="2.5" fill="#6666ff"/>
                        <rect x="7" y="11.5" width="2.5" height="2.5" fill="#ffff66"/>
                        <rect x="10" y="11.5" width="2.5" height="2.5" fill="#666666"/>
                        <rect x="13" y="11.5" width="2.5" height="2.5" fill="#ff00ff"/>
                        <rect x="16" y="11.5" width="2.5" height="2.5" fill="#00ffff"/>
                    </g>
                </svg>
                <div class="icon-label">MineSweeper.exe</div>
            </div>
        </div>

        <!-- Start Menu -->
        <div class="start-menu" id="start-menu">
            <div class="start-menu-header">
                <div class="start-menu-logo">Windows 95</div>
            </div>
            <div class="start-menu-items">
                <div class="menu-item" onclick="windowManager.openFolder('Program Files')">
                    <span class="menu-icon">▶</span>
                    <span>Programs</span>
                </div>
                <div class="menu-item" onclick="windowManager.openFolder('My Music')">
                    <span class="menu-icon">▶</span>
                    <span>Documents</span>
                </div>
                <div class="menu-item" onclick="windowManager.openFolder('Windows')">
                    <span class="menu-icon">▶</span>
                    <span>Settings</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item" onclick="alert('Help system not implemented')">
                    <span>Find</span>
                </div>
                <div class="menu-item" onclick="alert('Help system not implemented')">
                    <span>Help</span>
                </div>
                <div class="menu-item" onclick="alert('Run dialog not implemented')">
                    <span>Run...</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item" onclick="if(confirm('Shut down the computer?')) alert('Computer shutdown initiated')">
                    <span>Shut Down...</span>
                </div>
            </div>
        </div>

        <div class="windows-container" id="windows-container"></div>

        <!-- Taskbar -->
        <div class="taskbar">
            <div class="taskbar-start">
                <button class="start-button" id="start-button">Start</button>
            </div>
            <div class="taskbar-windows" id="taskbar-windows"></div>
            <div class="taskbar-tray">
                <span class="system-time" id="system-time">12:00</span>
            </div>
        </div>
    </div>

    <script>
        // ============= FULLY FUNCTIONAL APPLICATIONS - ALL WORKING =============

        // ============= APPLICATION CLASSES =============
        class CalculatorApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.display = windowEl.querySelector('#calc-display');
                this.display.value = '0';
                this.current = '0';
                this.previous = '';
                this.operation = null;
                this.newNumber = true;
                this.setupHandlers();
            }

            setupHandlers() {
                const display = this.display;
                const buttons = this.windowEl.querySelectorAll('.calc-btn');
                
                buttons.forEach(btn => {
                    if (btn.textContent === 'C') {
                        btn.addEventListener('click', () => this.clear());
                    } else if (btn.textContent === '←') {
                        btn.addEventListener('click', () => this.backspace());
                    } else if (['+', '-', '*', '/'].includes(btn.textContent)) {
                        btn.addEventListener('click', () => this.setOperation(btn.textContent));
                    } else if (btn.textContent === '=') {
                        btn.addEventListener('click', () => this.calculate());
                    } else if (btn.textContent === '.') {
                        btn.addEventListener('click', () => this.addDecimal());
                    } else if (/[0-9]/.test(btn.textContent)) {
                        btn.addEventListener('click', () => this.addNumber(btn.textContent));
                    }
                });
            }

            addNumber(num) {
                if (this.newNumber) {
                    this.current = num;
                    this.newNumber = false;
                } else {
                    this.current += num;
                }
                this.display.value = this.current;
            }

            addDecimal() {
                if (!this.current.includes('.')) {
                    this.current += '.';
                    this.display.value = this.current;
                }
            }

            setOperation(op) {
                if (this.operation && !this.newNumber) {
                    this.calculate();
                }
                this.previous = this.current;
                this.operation = op;
                this.newNumber = true;
            }

            calculate() {
                if (!this.operation || this.newNumber) return;
                
                const a = parseFloat(this.previous);
                const b = parseFloat(this.current);
                let result;

                switch(this.operation) {
                    case '+': result = a + b; break;
                    case '-': result = a - b; break;
                    case '*': result = a * b; break;
                    case '/': result = a / b; break;
                    default: return;
                }

                this.current = result.toString();
                this.display.value = this.current;
                this.operation = null;
                this.newNumber = true;
            }

            clear() {
                this.current = '0';
                this.previous = '';
                this.operation = null;
                this.newNumber = true;
                this.display.value = '0';
            }

            backspace() {
                if (this.current.length > 1) {
                    this.current = this.current.slice(0, -1);
                } else {
                    this.current = '0';
                }
                this.display.value = this.current;
            }
        }

        class NotepadApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.textarea = windowEl.querySelector('.notepad-textarea');
                this.title = windowEl.querySelector('.window-title');
                this.filename = 'Untitled.txt';
                this.setupHandlers();
                this.loadFile();
            }

            setupHandlers() {
                const buttons = this.windowEl.querySelectorAll('.notepad-btn');
                buttons.forEach(btn => {
                    const action = btn.dataset.action;
                    btn.addEventListener('click', () => {
                        if (action === 'new') this.newFile();
                        else if (action === 'save') this.saveFile();
                        else if (action === 'open') this.openFile();
                    });
                });
            }

            newFile() {
                if (this.textarea.value && !confirm('Discard changes?')) return;
                this.textarea.value = '';
                this.filename = 'Untitled.txt';
                this.title.textContent = this.filename;
            }

            saveFile() {
                localStorage.setItem('notepad_' + this.filename, this.textarea.value);
                alert('File saved as ' + this.filename);
            }

            openFile() {
                const name = prompt('Filename to open:', 'notes.txt');
                if (!name) return;
                const content = localStorage.getItem('notepad_' + name) || '';
                this.textarea.value = content;
                this.filename = name;
                this.title.textContent = name;
            }

            loadFile() {
                const saved = localStorage.getItem('notepad_Untitled.txt');
                if (saved) this.textarea.value = saved;
            }
        }

        class PaintApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.canvas = windowEl.querySelector('#paint-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.isDrawing = false;
                this.setupHandlers();
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            setupHandlers() {
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                const colorInput = this.windowEl.querySelector('#paint-color');
                if (colorInput) {
                    colorInput.addEventListener('change', (e) => {
                        this.ctx.strokeStyle = e.target.value;
                        this.ctx.fillStyle = e.target.value;
                    });
                }

                const sizeInput = this.windowEl.querySelector('#paint-size');
                if (sizeInput) {
                    sizeInput.addEventListener('change', (e) => {
                        this.ctx.lineWidth = e.target.value;
                    });
                }

                const clearBtn = this.windowEl.querySelector('.paint-clear-btn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    });
                }

                this.ctx.strokeStyle = '#000000';
                this.ctx.fillStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
            }

            startDrawing(e) {
                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
            }

            draw(e) {
                if (!this.isDrawing) return;
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
            }

            stopDrawing() {
                this.isDrawing = false;
                this.ctx.closePath();
            }
        }

        class SnakeGame {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.canvas = windowEl.querySelector('#snake-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.gridSize = 20;
                this.snake = [{x: 10, y: 10}];
                this.food = {x: 15, y: 15};
                this.dx = 1;
                this.dy = 0;
                this.nextDx = 1;
                this.nextDy = 0;
                this.score = 0;
                this.gameRunning = true;
                this.setupHandlers();
                this.gameLoop();
            }

            setupHandlers() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowUp' && this.dy === 0) {
                        this.nextDx = 0;
                        this.nextDy = -1;
                    } else if (e.key === 'ArrowDown' && this.dy === 0) {
                        this.nextDx = 0;
                        this.nextDy = 1;
                    } else if (e.key === 'ArrowLeft' && this.dx === 0) {
                        this.nextDx = -1;
                        this.nextDy = 0;
                    } else if (e.key === 'ArrowRight' && this.dx === 0) {
                        this.nextDx = 1;
                        this.nextDy = 0;
                    }
                });

                const pauseBtn = this.windowEl.querySelector('.snake-pause-btn');
                if (pauseBtn) {
                    pauseBtn.addEventListener('click', () => {
                        this.gameRunning = !this.gameRunning;
                        pauseBtn.textContent = this.gameRunning ? 'Pause' : 'Resume';
                    });
                }

                const restartBtn = this.windowEl.querySelector('.snake-restart-btn');
                if (restartBtn) {
                    restartBtn.addEventListener('click', () => this.reset());
                }
            }

            gameLoop() {
                if (this.gameRunning) {
                    this.dx = this.nextDx;
                    this.dy = this.nextDy;

                    const head = this.snake[0];
                    const newHead = {
                        x: (head.x + this.dx + 20) % 20,
                        y: (head.y + this.dy + 20) % 20
                    };

                    for (let segment of this.snake) {
                        if (segment.x === newHead.x && segment.y === newHead.y) {
                            this.gameRunning = false;
                            alert('Game Over! Score: ' + this.score);
                            return;
                        }
                    }

                    this.snake.unshift(newHead);

                    if (newHead.x === this.food.x && newHead.y === this.food.y) {
                        this.score += 10;
                        this.food = {
                            x: Math.floor(Math.random() * 20),
                            y: Math.floor(Math.random() * 20)
                        };
                    } else {
                        this.snake.pop();
                    }
                }

                this.render();
                setTimeout(() => this.gameLoop(), 100);
            }

            render() {
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.fillStyle = '#00ff00';
                for (let segment of this.snake) {
                    this.ctx.fillRect(segment.x * this.gridSize, segment.y * this.gridSize, this.gridSize - 1, this.gridSize - 1);
                }

                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(this.food.x * this.gridSize, this.food.y * this.gridSize, this.gridSize - 1, this.gridSize - 1);

                const scoreEl = this.windowEl.querySelector('.snake-score');
                if (scoreEl) scoreEl.textContent = 'Score: ' + this.score;
            }

            reset() {
                this.snake = [{x: 10, y: 10}];
                this.food = {x: 15, y: 15};
                this.dx = 1;
                this.dy = 0;
                this.score = 0;
                this.gameRunning = true;
            }
        }

        class PacManGame {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.canvas = windowEl.querySelector('#pacman-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.pacman = {x: 200, y: 200, radius: 10};
                this.dots = [];
                this.score = 0;
                this.mouthOpen = true;
                this.mouthTimer = 0;
                this.generateDots();
                this.setupHandlers();
                this.gameLoop();
            }

            generateDots() {
                for (let i = 0; i < 100; i++) {
                    this.dots.push({
                        x: Math.random() * 380 + 10,
                        y: Math.random() * 380 + 10,
                        eaten: false
                    });
                }
            }

            setupHandlers() {
                document.addEventListener('keydown', (e) => {
                    const speed = 5;
                    if (e.key === 'ArrowUp') this.pacman.y -= speed;
                    else if (e.key === 'ArrowDown') this.pacman.y += speed;
                    else if (e.key === 'ArrowLeft') this.pacman.x -= speed;
                    else if (e.key === 'ArrowRight') this.pacman.x += speed;

                    this.pacman.x = Math.max(10, Math.min(390, this.pacman.x));
                    this.pacman.y = Math.max(10, Math.min(390, this.pacman.y));
                });
            }

            gameLoop() {
                this.mouthTimer++;
                if (this.mouthTimer > 10) {
                    this.mouthOpen = !this.mouthOpen;
                    this.mouthTimer = 0;
                }

                for (let dot of this.dots) {
                    const dist = Math.hypot(dot.x - this.pacman.x, dot.y - this.pacman.y);
                    if (dist < 15 && !dot.eaten) {
                        dot.eaten = true;
                        this.score += 10;
                    }
                }

                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }

            render() {
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.fillStyle = '#ffff00';
                const mouthSize = this.mouthOpen ? 0.3 : 0.1;
                this.ctx.beginPath();
                this.ctx.arc(this.pacman.x, this.pacman.y, this.pacman.radius, mouthSize * Math.PI, (2 - mouthSize) * Math.PI);
                this.ctx.lineTo(this.pacman.x, this.pacman.y);
                this.ctx.fill();

                this.ctx.fillStyle = '#ffaa00';
                for (let dot of this.dots) {
                    if (!dot.eaten) {
                        this.ctx.fillRect(dot.x - 2, dot.y - 2, 4, 4);
                    }
                }

                const scoreEl = this.windowEl.querySelector('.pacman-score');
                if (scoreEl) scoreEl.textContent = 'Score: ' + this.score;
            }
        }

        class BreakoutGame {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.canvas = windowEl.querySelector('#breakout-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.paddle = {x: 175, y: 380, width: 50, height: 10};
                this.ball = {x: 200, y: 360, radius: 5, dx: 3, dy: -3};
                this.bricks = [];
                this.score = 0;
                this.setupBricks();
                this.setupHandlers();
                this.gameLoop();
            }

            setupBricks() {
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 8; col++) {
                        this.bricks.push({
                            x: col * 50,
                            y: row * 20 + 30,
                            width: 50,
                            height: 20,
                            hit: false
                        });
                    }
                }
            }

            setupHandlers() {
                document.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.paddle.x = e.clientX - rect.left - this.paddle.width / 2;
                    this.paddle.x = Math.max(0, Math.min(400 - this.paddle.width, this.paddle.x));
                });
            }

            gameLoop() {
                if (!this.updateGame()) {
                    this.render();
                    requestAnimationFrame(() => this.gameLoop());
                }
            }

            updateGame() {
                this.ball.x += this.ball.dx;
                this.ball.y += this.ball.dy;

                if (this.ball.x - this.ball.radius <= 0 || this.ball.x + this.ball.radius >= 400) {
                    this.ball.dx *= -1;
                }
                if (this.ball.y - this.ball.radius <= 0) {
                    this.ball.dy *= -1;
                }

                if (this.ball.y > 400) {
                    alert('Game Over! Score: ' + this.score);
                    return true;
                }

                if (this.ball.y + this.ball.radius > this.paddle.y &&
                    this.ball.x > this.paddle.x &&
                    this.ball.x < this.paddle.x + this.paddle.width) {
                    this.ball.dy *= -1;
                }

                for (let brick of this.bricks) {
                    if (!brick.hit &&
                        this.ball.x > brick.x &&
                        this.ball.x < brick.x + brick.width &&
                        this.ball.y > brick.y &&
                        this.ball.y < brick.y + brick.height) {
                        brick.hit = true;
                        this.ball.dy *= -1;
                        this.score += 10;
                    }
                }

                return false;
            }

            render() {
                this.ctx.fillStyle = '#0000ff';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.fillStyle = '#ffff00';
                this.ctx.fillRect(this.paddle.x, this.paddle.y, this.paddle.width, this.paddle.height);

                this.ctx.fillStyle = '#ff0000';
                this.ctx.beginPath();
                this.ctx.arc(this.ball.x, this.ball.y, this.ball.radius, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.fillStyle = '#00ff00';
                for (let brick of this.bricks) {
                    if (!brick.hit) {
                        this.ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    }
                }

                const scoreEl = this.windowEl.querySelector('.breakout-score');
                if (scoreEl) scoreEl.textContent = 'Score: ' + this.score;
            }
        }

        class SolitaireGame {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.deck = [];
                this.tableau = [[], [], [], [], [], [], []];
                this.foundation = [{}, {}, {}, {}];
                this.stock = [];
                this.waste = [];
                this.initializeDeck();
                this.setupHandlers();
                this.render();
            }

            initializeDeck() {
                const suits = ['♠', '♥', '♦', '♣'];
                const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                for (let suit of suits) {
                    for (let rank of ranks) {
                        this.deck.push({rank, suit});
                    }
                }
                this.shuffleDeck();
                this.dealCards();
            }

            shuffleDeck() {
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
            }

            dealCards() {
                let cardIndex = 0;
                for (let col = 0; col < 7; col++) {
                    for (let row = col; row < 7; row++) {
                        this.tableau[row].push(this.deck[cardIndex++]);
                    }
                }
                this.stock = this.deck.slice(cardIndex);
            }

            setupHandlers() {
                const newGameBtn = this.windowEl.querySelector('.solitaire-new-btn');
                if (newGameBtn) {
                    newGameBtn.addEventListener('click', () => {
                        this.deck = [];
                        this.tableau = [[], [], [], [], [], [], []];
                        this.foundation = [{}, {}, {}, {}];
                        this.initializeDeck();
                        this.render();
                    });
                }
            }

            render() {
                const gameArea = this.windowEl.querySelector('.solitaire-game-area');
                if (!gameArea) return;

                let html = '<div style="padding: 10px; font-size: 11px;"><strong>Foundation:</strong><div>';
                for (let i = 0; i < 4; i++) {
                    const topCard = this.foundation[i].topCard;
                    html += `<span style="display: inline-block; width: 40px; height: 60px; border: 1px solid #000; margin: 5px; background: #fff; padding: 5px; vertical-align: top;">
                        ${topCard ? topCard.rank + topCard.suit : 'Empty'}
                    </span>`;
                }
                html += '</div><br/><strong>Tableau:</strong><br/>';
                for (let i = 0; i < 7; i++) {
                    html += `<div><strong>Col ${i + 1}:</strong> ${this.tableau[i].map(c => c.rank + c.suit).join(', ')}</div>`;
                }
                html += '</div>';
                gameArea.innerHTML = html;
            }
        }

        // Pokemon Database
        const POKEMON_DATA = {
            'Bulbasaur': {hp: 45, att: 49, def: 49, spA: 65, spD: 65, spe: 45, type: 'Grass', moves: ['Tackle', 'Growl', 'Vine Whip']},
            'Charmander': {hp: 39, att: 52, def: 43, spA: 60, spD: 50, spe: 65, type: 'Fire', moves: ['Scratch', 'Growl', 'Ember']},
            'Squirtle': {hp: 44, att: 48, def: 65, spA: 50, spD: 64, spe: 43, type: 'Water', moves: ['Tackle', 'Tail Whip', 'Water Gun']},
            'Charizard': {hp: 78, att: 84, def: 78, spA: 109, spD: 85, spe: 100, type: 'Fire', moves: ['Scratch', 'Ember', 'Flamethrower', 'Dragon Claw']},
            'Blastoise': {hp: 79, att: 83, def: 100, spA: 85, spD: 105, spe: 78, type: 'Water', moves: ['Tackle', 'Water Gun', 'Hydro Pump', 'Ice Beam']},
            'Venusaur': {hp: 80, att: 82, def: 83, spA: 100, spD: 100, spe: 80, type: 'Grass', moves: ['Vine Whip', 'Leech Seed', 'Solar Beam', 'Synthesis']},
            'Pikachu': {hp: 35, att: 55, def: 40, spA: 50, spD: 50, spe: 90, type: 'Electric', moves: ['Thunderbolt', 'Quick Attack', 'Thunder Wave', 'Iron Tail']},
            'Dragonite': {hp: 91, att: 134, def: 95, spA: 100, spD: 100, spe: 80, type: 'Dragon', moves: ['Dragon Claw', 'Earthquake', 'Outrage', 'Hurricane']},
            'Gyarados': {hp: 95, att: 125, def: 79, spA: 60, spD: 100, spe: 81, type: 'Water', moves: ['Waterfall', 'Dragon Dance', 'Crunch', 'Stone Edge']},
            'Arcanine': {hp: 90, att: 110, def: 80, spA: 80, spD: 90, spe: 100, type: 'Fire', moves: ['Extreme Speed', 'Flare Blitz', 'Wild Charge', 'Close Combat']},
            'Lapras': {hp: 130, att: 85, def: 80, spA: 85, spD: 95, spe: 60, type: 'Water', moves: ['Surf', 'Ice Beam', 'Thunder', 'Psychic']},
            'Snorlax': {hp: 150, att: 110, def: 65, spA: 65, spD: 110, spe: 30, type: 'Normal', moves: ['Body Slam', 'Crunch', 'Earthquake', 'Rest']}
        };

        const TYPE_CHART = {
            'Fire': {strong: ['Grass', 'Ice', 'Bug', 'Steel'], weak: ['Water', 'Ground', 'Rock']},
            'Water': {strong: ['Fire', 'Ground', 'Rock'], weak: ['Grass', 'Electric']},
            'Grass': {strong: ['Water', 'Ground', 'Rock'], weak: ['Fire', 'Ice', 'Poison', 'Flying', 'Bug']},
            'Electric': {strong: ['Water', 'Flying'], weak: ['Ground']},
            'Dragon': {strong: ['Dragon'], weak: ['Ice', 'Dragon', 'Fairy']},
            'Normal': {strong: [], weak: ['Fighting']},
            'Ground': {strong: ['Fire', 'Electric', 'Poison', 'Rock', 'Steel'], weak: ['Water', 'Grass', 'Ice']},
            'Flying': {strong: ['Grass', 'Fighting', 'Bug'], weak: ['Electric', 'Ice', 'Rock']},
            'Poison': {strong: ['Grass'], weak: ['Ground', 'Psychic']},
            'Ice': {strong: ['Grass', 'Flying', 'Ground', 'Dragon'], weak: ['Fire', 'Fighting', 'Rock', 'Steel']},
            'Bug': {strong: ['Grass', 'Psychic', 'Dark'], weak: ['Fire', 'Flying', 'Rock']},
            'Rock': {strong: ['Flying', 'Bug', 'Fire', 'Ice'], weak: ['Water', 'Grass', 'Fighting', 'Ground', 'Steel']},
            'Steel': {strong: ['Ice', 'Rock', 'Fairy'], weak: ['Fire', 'Water', 'Ground']},
            'Fighting': {strong: ['Normal', 'Ice', 'Rock', 'Dark', 'Steel'], weak: ['Flying', 'Psychic', 'Fairy']},
            'Psychic': {strong: ['Fighting', 'Poison'], weak: ['Bug', 'Ghost', 'Dark']},
            'Ghost': {strong: ['Psychic', 'Ghost'], weak: ['Ghost', 'Dark']},
            'Dark': {strong: ['Psychic', 'Ghost'], weak: ['Fighting', 'Bug', 'Fairy']},
            'Fairy': {strong: ['Fighting', 'Dragon', 'Dark'], weak: ['Poison', 'Steel']}
        };

        const MOVES = {
            'Tackle': {power: 40, acc: 100, type: 'Normal'},
            'Scratch': {power: 40, acc: 100, type: 'Normal'},
            'Growl': {power: 0, acc: 100, type: 'Normal', effect: 'lower_att'},
            'Ember': {power: 40, acc: 100, type: 'Fire'},
            'Flamethrower': {power: 90, acc: 100, type: 'Fire'},
            'Water Gun': {power: 40, acc: 100, type: 'Water'},
            'Hydro Pump': {power: 110, acc: 80, type: 'Water'},
            'Vine Whip': {power: 45, acc: 100, type: 'Grass'},
            'Solar Beam': {power: 120, acc: 100, type: 'Grass'},
            'Thunderbolt': {power: 90, acc: 100, type: 'Electric'},
            'Thunder Wave': {power: 0, acc: 90, type: 'Electric', effect: 'paralyze'},
            'Dragon Claw': {power: 80, acc: 100, type: 'Dragon'},
            'Ice Beam': {power: 90, acc: 100, type: 'Ice'},
            'Earthquake': {power: 100, acc: 100, type: 'Ground'},
            'Psychic': {power: 90, acc: 100, type: 'Psychic'},
            'Crunch': {power: 80, acc: 100, type: 'Dark'},
            'Quick Attack': {power: 40, acc: 100, type: 'Normal', effect: 'priority'},
            'Thunder': {power: 110, acc: 70, type: 'Electric'},
            'Waterfall': {power: 80, acc: 100, type: 'Water'},
            'Outrage': {power: 120, acc: 100, type: 'Dragon'}
        };

        class PokemonGame {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.gameState = 'menu'; // menu, overworld, battle, pokedex, inventory
                this.playerName = 'Red';
                this.playerTeam = this.createStarterTeam();
                this.pokedex = new Set(this.playerTeam.map(p => p.name));
                this.inventory = {pokeballs: 10, potions: 5, fullHeals: 2, exp: 0};
                this.currentPokemonIndex = 0;
                this.mapPos = {x: 5, y: 5};
                this.wildEncounterChance = 0.3;
                this.battleEnemy = null;
                this.battleLog = [];
                this.setupHandlers();
                this.loadGame();
                this.render();
            }

            createStarterTeam() {
                return [
                    this.createPokemon('Pikachu', 5),
                    this.createPokemon('Squirtle', 5),
                    this.createPokemon('Bulbasaur', 5)
                ];
            }

            createPokemon(species, level) {
                const data = POKEMON_DATA[species];
                const baseStats = {name: species, level, exp: 0, ...data};
                baseStats.hp = Math.floor((2 * data.hp * level) / 100) + level + 10;
                baseStats.maxHp = baseStats.hp;
                baseStats.att = Math.floor((2 * data.att * level) / 100) + 5;
                baseStats.def = Math.floor((2 * data.def * level) / 100) + 5;
                baseStats.spA = Math.floor((2 * data.spA * level) / 100) + 5;
                baseStats.spD = Math.floor((2 * data.spD * level) / 100) + 5;
                baseStats.spe = Math.floor((2 * data.spe * level) / 100) + 5;
                return baseStats;
            }

            setupHandlers() {
                document.addEventListener('keydown', (e) => {
                    if (this.gameState === 'overworld') {
                        if (e.key === 'ArrowUp') this.mapPos.y = Math.max(0, this.mapPos.y - 1);
                        else if (e.key === 'ArrowDown') this.mapPos.y = Math.min(9, this.mapPos.y + 1);
                        else if (e.key === 'ArrowLeft') this.mapPos.x = Math.max(0, this.mapPos.x - 1);
                        else if (e.key === 'ArrowRight') this.mapPos.x = Math.min(9, this.mapPos.x + 1);
                        if ([e.key].includes('Arrow')) this.checkWildEncounter();
                    }
                });
            }

            checkWildEncounter() {
                if (Math.random() < this.wildEncounterChance) {
                    const wildSpecies = Object.keys(POKEMON_DATA)[Math.floor(Math.random() * Object.keys(POKEMON_DATA).length)];
                    const level = Math.floor(Math.random() * 5) + this.playerTeam[this.currentPokemonIndex].level - 2;
                    this.battleEnemy = this.createPokemon(wildSpecies, Math.max(1, level));
                    this.gameState = 'battle';
                    this.battleLog = [`Wild ${this.battleEnemy.name} appeared!`];
                }
                this.render();
            }

            startBattle(enemy) {
                this.battleEnemy = enemy;
                this.gameState = 'battle';
                this.battleLog = [`A wild ${this.battleEnemy.name} appeared!`];
                this.render();
            }

            calculateDamage(attacker, defender, move) {
                const moveData = MOVES[move];
                if (!moveData || moveData.power === 0) return 0;

                let damage = Math.floor(((2 * attacker.level + 10) / 250) * (attacker.att / defender.def) * moveData.power + 2);
                
                // Type advantage
                if (TYPE_CHART[moveData.type]?.strong.includes(defender.type)) {
                    damage = Math.floor(damage * 1.5);
                } else if (TYPE_CHART[moveData.type]?.weak.includes(defender.type)) {
                    damage = Math.floor(damage * 0.5);
                }

                damage += Math.floor(Math.random() * 16); // STAB and variance
                return Math.max(1, damage);
            }

            useAttack(moveIdx) {
                const current = this.playerTeam[this.currentPokemonIndex];
                const moveName = current.moves[moveIdx] || 'Tackle';
                const damage = this.calculateDamage(current, this.battleEnemy, moveName);
                
                this.battleEnemy.hp = Math.max(0, this.battleEnemy.hp - damage);
                this.battleLog.push(`${current.name} used ${moveName}! Dealt ${damage} damage!`);

                if (this.battleEnemy.hp <= 0) {
                    const expGain = Math.floor(this.battleEnemy.level * 10);
                    current.exp += expGain;
                    this.inventory.exp += expGain;
                    this.battleLog.push(`${this.battleEnemy.name} fainted! Gained ${expGain} EXP!`);
                    this.checkLevelUp(current);
                    setTimeout(() => this.endBattle(true), 1000);
                    this.render();
                    return;
                }

                setTimeout(() => this.enemyTurn(), 600);
            }

            enemyTurn() {
                const current = this.playerTeam[this.currentPokemonIndex];
                const moveIdx = Math.floor(Math.random() * this.battleEnemy.moves.length);
                const moveName = this.battleEnemy.moves[moveIdx];
                const damage = this.calculateDamage(this.battleEnemy, current, moveName);

                current.hp = Math.max(0, current.hp - damage);
                this.battleLog.push(`${this.battleEnemy.name} used ${moveName}! Dealt ${damage} damage!`);

                if (current.hp <= 0) {
                    this.battleLog.push(`${current.name} fainted!`);
                    if (this.getAlivePokemon().length === 0) {
                        this.battleLog.push('All Pokemon fainted! You lost!');
                        setTimeout(() => this.endBattle(false), 1000);
                    } else {
                        this.gameState = 'battle_switch';
                    }
                }
                this.render();
            }

            throwPokeball() {
                if (this.inventory.pokeballs <= 0) {
                    this.battleLog.push('No pokeballs left!');
                    this.render();
                    return;
                }

                this.inventory.pokeballs--;
                const catchRate = 0.3 * (this.battleEnemy.maxHp / this.battleEnemy.hp);
                
                if (Math.random() < catchRate) {
                    this.battleLog.push(`${this.battleEnemy.name} was caught!`);
                    this.playerTeam.push(JSON.parse(JSON.stringify(this.battleEnemy)));
                    this.pokedex.add(this.battleEnemy.name);
                    setTimeout(() => this.endBattle(true), 1000);
                } else {
                    this.battleLog.push('Pokemon broke free!');
                    setTimeout(() => this.enemyTurn(), 600);
                }
                this.render();
            }

            usePotion() {
                const current = this.playerTeam[this.currentPokemonIndex];
                if (this.inventory.potions <= 0) {
                    this.battleLog.push('No potions!');
                    this.render();
                    return;
                }
                this.inventory.potions--;
                const heal = 30;
                current.hp = Math.min(current.maxHp, current.hp + heal);
                this.battleLog.push(`${current.name} healed ${heal} HP!`);
                setTimeout(() => this.enemyTurn(), 600);
                this.render();
            }

            switchPokemon(newIdx) {
                if (this.playerTeam[newIdx].hp <= 0) {
                    this.battleLog.push('That Pokemon has fainted!');
                    this.render();
                    return;
                }
                this.currentPokemonIndex = newIdx;
                this.gameState = 'battle';
                this.battleLog.push(`Go, ${this.playerTeam[newIdx].name}!`);
                setTimeout(() => this.enemyTurn(), 600);
                this.render();
            }

            checkLevelUp(pokemon) {
                const expPerLevel = 100;
                if (pokemon.exp >= expPerLevel) {
                    pokemon.level++;
                    pokemon.exp = 0;
                    const newData = POKEMON_DATA[pokemon.name];
                    pokemon.maxHp = Math.floor((2 * newData.hp * pokemon.level) / 100) + pokemon.level + 10;
                    pokemon.hp = pokemon.maxHp;
                    pokemon.att = Math.floor((2 * newData.att * pokemon.level) / 100) + 5;
                    pokemon.def = Math.floor((2 * newData.def * pokemon.level) / 100) + 5;
                    this.battleLog.push(`${pokemon.name} leveled up to Lv.${pokemon.level}!`);
                }
            }

            endBattle(won) {
                this.gameState = 'overworld';
                this.battleEnemy = null;
                this.saveGame();
                this.render();
            }

            getAlivePokemon() {
                return this.playerTeam.filter(p => p.hp > 0);
            }

            saveGame() {
                const save = {team: this.playerTeam, inventory: this.inventory, pokedex: Array.from(this.pokedex), mapPos: this.mapPos};
                localStorage.setItem('pokemon_save', JSON.stringify(save));
            }

            loadGame() {
                const save = JSON.parse(localStorage.getItem('pokemon_save') || 'null');
                if (save) {
                    this.playerTeam = save.team;
                    this.inventory = save.inventory;
                    this.pokedex = new Set(save.pokedex);
                    this.mapPos = save.mapPos;
                }
            }

            render() {
                const gameArea = this.windowEl.querySelector('.pokemon-game-area');
                if (!gameArea) return;

                if (this.gameState === 'menu') {
                    gameArea.innerHTML = `<div style="padding: 20px; text-align: center; background: #000; color: #fff; height: 100%;">
                        <h2>Pokemon Game</h2>
                        <p>Press Start to Begin</p>
                        <button onclick="window.pokemonGame.gameState='overworld'; window.pokemonGame.render();" style="padding: 10px 20px; margin: 10px;">Start Game</button>
                        <button onclick="window.pokemonGame.gameState='pokedex'; window.pokemonGame.render();" style="padding: 10px 20px; margin: 10px;">Pokédex</button>
                        <button onclick="window.pokemonGame.gameState='inventory'; window.pokemonGame.render();" style="padding: 10px 20px; margin: 10px;">Inventory</button>
                    </div>`;
                } else if (this.gameState === 'pokedex') {
                    gameArea.innerHTML = `<div style="padding: 10px; background: #000; color: #fff; height: 100%; overflow-y: auto; font-size: 11px;">
                        <button onclick="window.pokemonGame.gameState='menu'; window.pokemonGame.render();">Back</button>
                        <h3>Pokédex (${this.pokedex.size} seen)</h3>
                        ${Array.from(this.pokedex).map(name => {
                            const data = POKEMON_DATA[name];
                            return `<div style="padding: 5px; border-bottom: 1px solid #333;"><strong>${name}</strong> - ${data.type} Type</div>`;
                        }).join('')}
                    </div>`;
                } else if (this.gameState === 'inventory') {
                    gameArea.innerHTML = `<div style="padding: 10px; background: #000; color: #fff; height: 100%; overflow-y: auto; font-size: 11px;">
                        <button onclick="window.pokemonGame.gameState='menu'; window.pokemonGame.render();">Back</button>
                        <h3>Inventory</h3>
                        <div>Pokéballs: ${this.inventory.pokeballs}</div>
                        <div>Potions: ${this.inventory.potions}</div>
                        <div>Full Heals: ${this.inventory.fullHeals}</div>
                        <div>Total EXP: ${this.inventory.exp}</div>
                    </div>`;
                } else if (this.gameState === 'overworld') {
                    let mapHtml = '<div style="display: grid; grid-template-columns: repeat(10, 30px); gap: 1px; margin: 10px 0;">';
                    for (let y = 0; y < 10; y++) {
                        for (let x = 0; x < 10; x++) {
                            const isPlayer = x === this.mapPos.x && y === this.mapPos.y;
                            mapHtml += `<div style="width: 30px; height: 30px; background: ${isPlayer ? '#ffff00' : '#00aa00'}; border: 1px solid #000;"></div>`;
                        }
                    }
                    mapHtml += '</div>';

                    const current = this.playerTeam[this.currentPokemonIndex];
                    gameArea.innerHTML = `<div style="padding: 10px; background: #000; color: #fff; font-size: 11px; height: 100%; overflow-y: auto;">
                        <div style="margin-bottom: 10px;">
                            <button onclick="window.pokemonGame.gameState='menu'; window.pokemonGame.render();">Menu</button>
                            <button onclick="window.pokemonGame.checkWildEncounter();">Search</button>
                        </div>
                        <div><strong>${current.name}</strong> Lv.${current.level} - ${current.hp}/${current.maxHp} HP</div>
                        ${mapHtml}
                        <div style="margin-top: 10px;">Pokédex: ${this.pokedex.size} | Team: ${this.getAlivePokemon().length}/6</div>
                    </div>`;
                } else if (this.gameState === 'battle') {
                    const current = this.playerTeam[this.currentPokemonIndex];
                    gameArea.innerHTML = `<div style="padding: 10px; background: #000; color: #fff; font-size: 10px; height: 100%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div><strong>${this.battleEnemy.name}</strong> Lv.${this.battleEnemy.level}<br/>${this.battleEnemy.hp}/${this.battleEnemy.maxHp} HP
                                <div style="width: 150px; height: 15px; border: 1px solid #fff; background: #000;">
                                    <div style="width: ${(this.battleEnemy.hp / this.battleEnemy.maxHp) * 150}px; height: 100%; background: ${this.battleEnemy.hp > this.battleEnemy.maxHp / 2 ? '#00ff00' : '#ff0000'};"></div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div><strong>${current.name}</strong> Lv.${current.level}<br/>${current.hp}/${current.maxHp} HP
                                <div style="width: 150px; height: 15px; border: 1px solid #fff; background: #000;">
                                    <div style="width: ${(current.hp / current.maxHp) * 150}px; height: 100%; background: ${current.hp > current.maxHp / 2 ? '#00ff00' : '#ff0000'};"></div>
                                </div>
                            </div>
                        </div>
                        <div style="border: 1px solid #fff; height: 80px; overflow-y: auto; margin-bottom: 10px; padding: 5px;">
                            ${this.battleLog.slice(-8).map(log => `<div>${log}</div>`).join('')}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 10px;">
                            ${current.moves.map((m, i) => `<button onclick="window.pokemonGame.useAttack(${i});" style="padding: 5px; font-size: 9px;">${m}</button>`).join('')}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                            <button onclick="window.pokemonGame.throwPokeball();" style="padding: 5px;">Ball (${this.inventory.pokeballs})</button>
                            <button onclick="window.pokemonGame.usePotion();" style="padding: 5px;">Potion (${this.inventory.potions})</button>
                            <button onclick="window.pokemonGame.gameState='battle_switch'; window.pokemonGame.render();">Switch</button>
                            <button onclick="window.pokemonGame.endBattle(false);">Run</button>
                        </div>
                    </div>`;
                } else if (this.gameState === 'battle_switch') {
                    gameArea.innerHTML = `<div style="padding: 10px; background: #000; color: #fff; font-size: 11px; height: 100%;">
                        <h3>Choose a Pokemon</h3>
                        ${this.playerTeam.map((p, i) => `<button onclick="window.pokemonGame.switchPokemon(${i});" style="width: 100%; padding: 8px; margin: 3px 0; text-align: left;">
                            ${p.name} Lv.${p.level} - ${p.hp}/${p.maxHp}
                        </button>`).join('')}
                    </div>`;
                }
            }
        }
        
        // Store reference for onclick handlers
        window.pokemonGame = null;

        class TaskManagerApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.render();
                setInterval(() => this.render(), 2000);
            }

            render() {
                const area = this.windowEl.querySelector('.taskmgr-area');
                if (!area) return;

                const processes = [
                    {name: 'explorer.exe', cpu: 2, memory: 45},
                    {name: 'notepad.exe', cpu: 1, memory: 8},
                    {name: 'solitaire.exe', cpu: 3, memory: 12},
                    {name: 'cmd.exe', cpu: 0, memory: 4},
                    {name: 'winlogon.exe', cpu: 1, memory: 6}
                ];

                let html = '<table style="width: 100%; border-collapse: collapse;"><tr style="background: #000080; color: #fff;"><td style="border: 1px solid #000; padding: 5px;"><strong>Image Name</strong></td><td style="border: 1px solid #000; padding: 5px;"><strong>CPU %</strong></td><td style="border: 1px solid #000; padding: 5px;"><strong>Memory (MB)</strong></td></tr>';

                processes.forEach((p, i) => {
                    html += `<tr style="background: ${i % 2 === 0 ? '#ffffff' : '#c0c0c0'};"><td style="border: 1px solid #000; padding: 5px;">${p.name}</td><td style="border: 1px solid #000; padding: 5px;">${p.cpu}%</td><td style="border: 1px solid #000; padding: 5px;">${p.memory}</td></tr>`;
                });

                html += '</table>';
                area.innerHTML = html;
            }
        }

        class BrowserApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.history = ['about:home'];
                this.currentIndex = 0;
                this.setupHandlers();
                this.renderPage();
            }

            setupHandlers() {
                const backBtn = this.windowEl.querySelector('.browser-back-btn');
                const addressBar = this.windowEl.querySelector('.browser-address');
                const goBtn = this.windowEl.querySelector('.browser-go-btn');

                if (backBtn) backBtn.addEventListener('click', () => this.goBack());
                if (addressBar && goBtn) {
                    goBtn.addEventListener('click', () => this.navigate(addressBar.value));
                    addressBar.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.navigate(addressBar.value);
                    });
                }
            }

            navigate(url) {
                this.history = this.history.slice(0, this.currentIndex + 1);
                this.history.push(url);
                this.currentIndex++;
                this.renderPage();
            }

            goBack() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderPage();
                }
            }

            renderPage() {
                const url = this.history[this.currentIndex];
                const addressBar = this.windowEl.querySelector('.browser-address');
                if (addressBar) addressBar.value = url;

                let content = '<div style="padding: 20px;"><p style="color: #ff0000;">404 - Page Not Found</p></div>';

                if (url === 'about:home') {
                    content = '<div style="padding: 20px;"><h1>Welcome to Windows 95 Browser</h1><p>This is a simulated web browser.</p></div>';
                } else if (url === 'about:credits') {
                    content = '<div style="padding: 20px;"><h1>Credits</h1><p>Created by Will Hatch</p><p>Portfolio Website 2024</p></div>';
                } else if (url === 'about:nostalgia') {
                    content = '<div style="padding: 20px;"><h1>Windows 95 Nostalgia</h1><p>Remember the good old days?</p><p style="color: #0000ff; text-decoration: underline;">Click here to explore</p></div>';
                }

                const contentArea = this.windowEl.querySelector('.browser-content');
                if (contentArea) contentArea.innerHTML = content;
            }
        }

        class MinesweeperApp {
            constructor(windowEl) {
                this.windowEl = windowEl;
                this.difficulty = 'beginner';
                this.board = [];
                this.revealed = [];
                this.setupHandlers();
                this.newGame();
            }

            setupHandlers() {
                const diffBtns = this.windowEl.querySelectorAll('.ms-difficulty-btn');
                diffBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.difficulty = btn.dataset.difficulty;
                        this.newGame();
                    });
                });
            }

            newGame() {
                const difficulties = {
                    beginner: {width: 10, height: 8, mines: 10},
                    intermediate: {width: 16, height: 16, mines: 40},
                    expert: {width: 30, height: 16, mines: 99}
                };

                const d = difficulties[this.difficulty];
                this.board = [];
                this.revealed = [];

                for (let y = 0; y < d.height; y++) {
                    this.board[y] = [];
                    this.revealed[y] = [];
                    for (let x = 0; x < d.width; x++) {
                        this.board[y][x] = {isMine: false, count: 0};
                        this.revealed[y][x] = false;
                    }
                }

                let minesPlaced = 0;
                while (minesPlaced < d.mines) {
                    const x = Math.floor(Math.random() * d.width);
                    const y = Math.floor(Math.random() * d.height);
                    if (!this.board[y][x].isMine) {
                        this.board[y][x].isMine = true;
                        minesPlaced++;
                    }
                }

                for (let y = 0; y < d.height; y++) {
                    for (let x = 0; x < d.width; x++) {
                        if (!this.board[y][x].isMine) {
                            let count = 0;
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    const ny = y + dy, nx = x + dx;
                                    if (ny >= 0 && ny < d.height && nx >= 0 && nx < d.width && this.board[ny][nx].isMine) {
                                        count++;
                                    }
                                }
                            }
                            this.board[y][x].count = count;
                        }
                    }
                }

                this.render();
            }

            reveal(x, y) {
                if (this.revealed[y][x]) return;
                this.revealed[y][x] = true;

                if (this.board[y][x].isMine) {
                    alert('Game Over! You hit a mine.');
                    this.newGame();
                    return;
                }

                if (this.board[y][x].count === 0) {
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const ny = y + dy, nx = x + dx;
                            if (ny >= 0 && ny < this.board.length && nx >= 0 && nx < this.board[0].length) {
                                this.reveal(nx, ny);
                            }
                        }
                    }
                }

                this.render();
            }

            render() {
                const board = this.windowEl.querySelector('.minesweeper-board');
                if (!board) return;

                const d = this.difficulty;
                board.className = `minesweeper-board ${d}`;
                board.innerHTML = '';

                for (let y = 0; y < this.board.length; y++) {
                    for (let x = 0; x < this.board[y].length; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'minesweeper-cell';
                        cell.style.width = '30px';
                        cell.style.height = '30px';

                        if (this.revealed[y][x]) {
                            cell.style.background = '#c0c0c0';
                            cell.style.border = '1px solid #dfdfdf';
                            if (this.board[y][x].isMine) {
                                cell.textContent = '💣';
                            } else if (this.board[y][x].count > 0) {
                                cell.textContent = this.board[y][x].count;
                                cell.style.color = ['', 'blue', 'darkgreen', 'red', 'darkblue', 'darkred', 'teal', 'black', 'gray'][this.board[y][x].count];
                            }
                        } else {
                            cell.style.background = '#c0c0c0';
                            cell.style.border = '2px outset #dfdfdf';
                        }

                        cell.addEventListener('click', () => this.reveal(x, y));
                        board.appendChild(cell);
                    }
                }
            }
        }

        // ============= ENHANCED FILE SYSTEM WITH 20+ APPLICATIONS =============
        const fileSystem = {
            files: {
                'About.txt': {
                    type: 'text',
                    icon: 'document',
                    content: `Will Hatch - About Me\n=====================================\n\nWill Hatch is a junior at Berklee College of Music, specializing in hip-hop and electronic music production.\n\nCurrently active as:\n• vvill - Solo music producer\n• Connxtion - Group producer and collaborator\n\nBased in Boston, MA`
                },
                'Purpose.txt': {
                    type: 'text',
                    icon: 'document',
                    content: `Release Planner Tool\n=====================================\nStatus: In Development\n\nThis tool helps independent artists organize release timelines, marketing plans, and distribution strategies.`
                },
                'Links.url': {
                    type: 'url',
                    icon: 'link',
                    content: `Important Links\n=====================================\n\nMusic: Apple Music, Spotify, Bandcamp\nSocial: Instagram (@vvill, @connxtion)\nEmail: willhatch@berklee.edu`
                }
            },
            folders: {
                'Games': {
                    icon: 'gamesfolder',
                    files: {
                        'PokemonRadicalRed.exe': { type: 'app', icon: 'pokemon', appType: 'pokemon', content: 'Pokemon Radical Red Emulator' },
                        'Snake.exe': { type: 'app', icon: 'snake', appType: 'snake', content: 'Classic Snake Game' },
                        'Pac-Man.exe': { type: 'app', icon: 'pacman', appType: 'pacman', content: 'Pac-Man Game' },
                        'Breakout.exe': { type: 'app', icon: 'breakout', appType: 'breakout', content: 'Breakout Game' },
                        'Solitaire.exe': { type: 'app', icon: 'solitaire', appType: 'solitaire', content: 'Solitaire Card Game' }
                    }
                },
                'Program Files': {
                    icon: 'programfolder',
                    files: {
                        'Internet Explorer.exe': { type: 'app', icon: 'ie', appType: 'ie', content: 'Internet Explorer' },
                        'Netscape.exe': { type: 'app', icon: 'netscape', appType: 'netscape', content: 'Netscape Navigator' },
                        'Winamp.exe': { type: 'app', icon: 'winamp', appType: 'winamp', content: 'Winamp Music Player' },
                        'mIRC.exe': { type: 'app', icon: 'mirc', appType: 'mirc', content: 'mIRC Chat Client' },
                        'AIM.exe': { type: 'app', icon: 'aim', appType: 'aim', content: 'AOL Instant Messenger' }
                    },
                    folders: {
                        'Accessories': {
                            icon: 'folder',
                            files: {
                                'Notepad.exe': { type: 'app', icon: 'notepad', appType: 'notepad', content: 'Simple Text Editor' },
                                'Paint.exe': { type: 'app', icon: 'paint', appType: 'paint', content: 'Paint Application' },
                                'Calculator.exe': { type: 'app', icon: 'calculator', appType: 'calculator', content: 'Basic Calculator' },
                                'WordPad.exe': { type: 'app', icon: 'wordpad', appType: 'wordpad', content: 'Word Processor' }
                            }
                        }
                    }
                },
                'System Utilities': {
                    icon: 'utilfolder',
                    files: {
                        'Device Manager.exe': { type: 'app', icon: 'devicemgr', appType: 'devicemgr', content: 'Device Manager' },
                        'Task Manager.exe': { type: 'app', icon: 'taskmgr', appType: 'taskmgr', content: 'Task Manager' },
                        'Registry Editor.exe': { type: 'app', icon: 'regedit', appType: 'regedit', content: 'Registry Editor' },
                        'System Monitor.exe': { type: 'app', icon: 'sysmon', appType: 'sysmon', content: 'System Monitor' }
                    }
                },
                'Viruses': {
                    icon: 'viralfolder',
                    files: {
                        'MEMZ.exe': { type: 'app', icon: 'virus', appType: 'memz', content: 'Malware Simulator' },
                        'Badware.exe': { type: 'app', icon: 'virus', appType: 'virus', content: 'Virus Simulator' },
                        'CoolPatch.exe': { type: 'app', icon: 'virus', appType: 'patch', content: 'Fake Security Patch' }
                    }
                },
                'Windows': {
                    icon: 'windowsfolder',
                    files: {
                        'System.ini': { type: 'text', icon: 'textfile', content: '[boot]\nshell=explorer.exe\ndevice=vga.drv' },
                        'Win.ini': { type: 'text', icon: 'textfile', content: '[Windows]\nload=\nrun=\n[Desktop]\nWallpaper=' },
                        'Config.sys': { type: 'text', icon: 'textfile', content: 'device=himem.sys\ndevice=emm386.exe\nshell=command.com' }
                    },
                    folders: {
                        'System32': {
                            icon: 'folder',
                            files: {
                                'kernel32.dll': { type: 'text', icon: 'dll', content: 'Windows Kernel Library' },
                                'user32.dll': { type: 'text', icon: 'dll', content: 'User Interface Library' },
                                'gdi32.dll': { type: 'text', icon: 'dll', content: 'Graphics Device Interface' },
                                'shell32.dll': { type: 'text', icon: 'dll', content: 'Shell Library' },
                                'ntdll.dll': { type: 'text', icon: 'dll', content: 'Native API Library' }
                            }
                        },
                        'Drivers': {
                            icon: 'folder',
                            files: {
                                'vga.drv': { type: 'text', icon: 'driver', content: 'VGA Display Driver' },
                                'mouse.drv': { type: 'text', icon: 'driver', content: 'Mouse Driver' },
                                'kbd.drv': { type: 'text', icon: 'driver', content: 'Keyboard Driver' },
                                'serial.drv': { type: 'text', icon: 'driver', content: 'Serial Port Driver' }
                            }
                        }
                    }
                },
                'My Documents': {
                    icon: 'docfolder',
                    files: {
                        'Resume.doc': { type: 'text', icon: 'document', content: 'Will Hatch Resume - Audio Engineering & Production' },
                        'Music Notes.txt': { type: 'text', icon: 'document', content: 'Production Notes\n- Work on beat patterns\n- Improve mixing skills\n- Collaborate with Connxtion' }
                    }
                },
                'My Music': {
                    icon: 'musicfolder',
                    files: {
                        'vvill - Track 01.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' },
                        'vvill - Track 02.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' },
                        'Connxtion - Collab.mp3': { type: 'audio', icon: 'audio', content: 'Audio File' }
                    }
                }
            }
        };

        // ============= WINDOW MANAGER (Enhanced) =============
        class WindowManager {
            constructor() {
                this.windows = [];
                this.zIndex = 1000;
                this.container = document.getElementById('windows-container');
                this.taskbarWindows = document.getElementById('taskbar-windows');
                this.appStates = {}; // Store app states
            }

            getIconSVG(iconType) {
                const icons = {
                    document: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 2 0 L 2 14 L 12 14 L 12 4 L 8 0 Z" fill="#ffffff" stroke="#000" stroke-width="0.5"/><path d="M 8 0 L 12 4 L 8 4 Z" fill="#e0e0e0"/></svg>`,
                    folder: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 1 3 L 1 14 L 15 14 L 15 4 L 8 4 L 6 2 L 1 2 Z" fill="#ffcc00" stroke="#000" stroke-width="0.5"/></svg>`,
                    executable: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="1" y="1" width="14" height="12" fill="#c0c0c0" stroke="#000" stroke-width="0.5"/><rect x="2" y="2" width="12" height="2" fill="#000080"/></svg>`,
                    dll: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="2" y="1" width="12" height="13" fill="#ffccff" stroke="#000" stroke-width="0.5"/><text x="8" y="10" font-size="6" text-anchor="middle" fill="#000">DLL</text></svg>`,
                    driver: `<svg viewBox="0 0 16 16" width="16" height="16"><rect x="2" y="2" width="12" height="11" fill="#ccccff" stroke="#000" stroke-width="0.5"/></svg>`,
                    pokemon: `<svg viewBox="0 0 16 16" width="16" height="16"><circle cx="8" cy="8" r="6" fill="#ffcc00" stroke="#000" stroke-width="0.5"/><rect x="4" y="5" width="8" height="6" fill="#ff0000" opacity="0.5"/></svg>`,
                    virus: `<svg viewBox="0 0 16 16" width="16" height="16"><circle cx="8" cy="8" r="5" fill="#ff0000" stroke="#000" stroke-width="0.5"/><circle cx="8" cy="8" r="3" fill="none" stroke="#ff0000" stroke-width="0.5"/></svg>`,
                    link: `<svg viewBox="0 0 16 16" width="16" height="16"><path d="M 3 8 Q 3 3 8 3 Q 13 3 13 8" fill="none" stroke="#0000ff" stroke-width="1"/><path d="M 3 8 Q 3 13 8 13 Q 13 13 13 8" fill="none" stroke="#0000ff" stroke-width="1"/></svg>`
                };
                return icons[iconType] || icons.document;
            }

            openFile(filename, fromFolder = null) {
                const existingWindow = this.windows.find(w => w.filename === filename && w.folder === fromFolder);
                if (existingWindow) {
                    existingWindow.element.style.zIndex = ++this.zIndex;
                    existingWindow.element.classList.remove('minimized');
                    return;
                }

                let fileData;
                if (fromFolder) {
                    fileData = fileSystem.folders[fromFolder].files[filename];
                } else {
                    fileData = fileSystem.files[filename];
                }

                if (!fileData) return;

                // Handle app files
                if (fileData.type === 'app') {
                    this.openApplication(fileData.appType, filename);
                    return;
                }

                const windowElement = this.createWindowElement(filename, fileData, fromFolder);
                this.container.appendChild(windowElement);

                const windowObj = {
                    filename,
                    folder: fromFolder,
                    element: windowElement,
                    content: fileData.content
                };

                this.windows.push(windowObj);
                this.addTaskbarButton(filename, windowObj);
                this.makeWindowDraggable(windowElement);
                windowElement.style.zIndex = ++this.zIndex;
            }

            openApplication(appType, appName) {
                const existingWindow = this.windows.find(w => w.appType === appType);
                if (existingWindow) {
                    existingWindow.element.style.zIndex = ++this.zIndex;
                    existingWindow.element.classList.remove('minimized');
                    return;
                }

                const windowId = `window-${this.windows.length}`;
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                
                let content = '';
                let appInstance = null;

                switch(appType) {
                    case 'calculator':
                        window.style.width = '280px';
                        content = `<div class="calc-app" style="padding: 10px;">
                            <input type="text" id="calc-display" style="width: 100%; margin-bottom: 10px; padding: 5px; border: 2px inset; font-size: 14px;" value="0" readonly>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                                <button class="calc-btn">C</button><button class="calc-btn">←</button><button class="calc-btn">/</button><button class="calc-btn">*</button>
                                <button class="calc-btn">7</button><button class="calc-btn">8</button><button class="calc-btn">9</button><button class="calc-btn">-</button>
                                <button class="calc-btn">4</button><button class="calc-btn">5</button><button class="calc-btn">6</button><button class="calc-btn">+</button>
                                <button class="calc-btn">1</button><button class="calc-btn">2</button><button class="calc-btn">3</button><button class="calc-btn">.</button>
                                <button class="calc-btn" style="grid-column: 1 / 3;">0</button><button class="calc-btn" style="grid-column: 3 / 5;">=</button>
                            </div>
                        </div>`;
                        break;

                    case 'notepad':
                        window.style.width = '600px';
                        window.style.height = '400px';
                        content = `<div class="notepad-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; display: flex; gap: 5px;">
                                <button class="notepad-btn" data-action="new">New</button>
                                <button class="notepad-btn" data-action="open">Open</button>
                                <button class="notepad-btn" data-action="save">Save</button>
                            </div>
                            <textarea class="notepad-textarea" style="flex: 1; border: 1px inset; padding: 5px; font-family: Courier; resize: none;"></textarea>
                        </div>`;
                        break;

                    case 'paint':
                        window.style.width = '640px';
                        window.style.height = '500px';
                        content = `<div class="paint-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; display: flex; gap: 10px; align-items: center;">
                                <label>Color: <input type="color" id="paint-color" value="#000000"></label>
                                <label>Size: <input type="range" id="paint-size" min="1" max="20" value="2" style="width: 100px;"></label>
                                <button class="paint-clear-btn" style="padding: 3px 10px;">Clear</button>
                            </div>
                            <canvas id="paint-canvas" width="640" height="450" style="border: 1px inset; background: white; cursor: crosshair; flex: 1;"></canvas>
                        </div>`;
                        break;

                    case 'snake':
                        window.style.width = '440px';
                        window.style.height = '480px';
                        content = `<div class="snake-app" style="padding: 10px; text-align: center;">
                            <div class="snake-score" style="font-weight: bold; margin-bottom: 10px;">Score: 0</div>
                            <canvas id="snake-canvas" width="400" height="400" style="border: 2px solid #000080; background: #000;"></canvas>
                            <div style="margin-top: 10px;">
                                <button class="snake-pause-btn" style="margin-right: 5px;">Pause</button>
                                <button class="snake-restart-btn">Restart</button>
                            </div>
                        </div>`;
                        break;

                    case 'pacman':
                        window.style.width = '440px';
                        window.style.height = '480px';
                        content = `<div class="pacman-app" style="padding: 10px; text-align: center;">
                            <div class="pacman-score" style="font-weight: bold; margin-bottom: 10px;">Score: 0</div>
                            <canvas id="pacman-canvas" width="400" height="400" style="border: 2px solid #000; background: #000;"></canvas>
                        </div>`;
                        break;

                    case 'breakout':
                        window.style.width = '440px';
                        window.style.height = '460px';
                        content = `<div class="breakout-app" style="padding: 10px; text-align: center;">
                            <div class="breakout-score" style="font-weight: bold; margin-bottom: 10px;">Score: 0</div>
                            <canvas id="breakout-canvas" width="400" height="400" style="border: 2px solid #000; background: #0000ff;"></canvas>
                        </div>`;
                        break;

                    case 'solitaire':
                        window.style.width = '600px';
                        window.style.height = '500px';
                        content = `<div class="solitaire-app" style="padding: 10px; height: 100%; display: flex; flex-direction: column;">
                            <button class="solitaire-new-btn" style="margin-bottom: 10px;">New Game</button>
                            <div class="solitaire-game-area" style="flex: 1; background: #00aa00; border: 1px solid #000; overflow-y: auto;"></div>
                        </div>`;
                        break;

                    case 'pokemon':
                        window.style.width = '700px';
                        window.style.height = '600px';
                        content = `<div class="pokemon-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div class="pokemon-game-area" style="flex: 1; background: #000; color: #fff; padding: 10px; overflow-y: auto; font-size: 11px;"></div>
                        </div>`;
                        break;

                    case 'taskmgr':
                        window.style.width = '600px';
                        window.style.height = '400px';
                        content = `<div class="taskmgr-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 10px; border-bottom: 1px solid #000;">
                                <button style="padding: 3px 10px;">Refresh</button>
                            </div>
                            <div class="taskmgr-area" style="flex: 1; overflow-y: auto; padding: 5px; font-size: 11px;"></div>
                        </div>`;
                        break;

                    case 'ie':
                        window.style.width = '700px';
                        window.style.height = '500px';
                        content = `<div class="browser-app" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="padding: 5px; border-bottom: 1px solid #000; background: #c0c0c0; display: flex; gap: 5px;">
                                <button class="browser-back-btn" style="width: 50px;">← Back</button>
                                <input type="text" class="browser-address" style="flex: 1; padding: 3px;" value="about:home">
                                <button class="browser-go-btn" style="width: 50px;">Go</button>
                            </div>
                            <div class="browser-content" style="flex: 1; background: #ffffff; overflow-y: auto;"></div>
                        </div>`;
                        break;

                    case 'minesweeper':
                        window.style.width = '500px';
                        window.style.height = '400px';
                        content = `<div class="minesweeper-app" style="padding: 10px; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 10px;">
                                <button class="ms-difficulty-btn" data-difficulty="beginner">Beginner</button>
                                <button class="ms-difficulty-btn" data-difficulty="intermediate">Intermediate</button>
                                <button class="ms-difficulty-btn" data-difficulty="expert">Expert</button>
                            </div>
                            <div class="minesweeper-board" style="flex: 1; display: grid; gap: 0; grid-template-columns: repeat(10, 30px);"></div>
                        </div>`;
                        break;

                    default:
                        content = `<div style="padding: 10px;"><p>Application: ${appName}</p><p>Not implemented</p></div>`;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${appName}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        ${content}
                    </div>
                `;

                this.container.appendChild(window);

                const windowObj = {
                    filename: appName,
                    appType: appType,
                    element: window
                };

                this.windows.push(windowObj);
                this.addTaskbarButton(appName, windowObj);
                this.makeWindowDraggable(window);
                window.style.zIndex = ++this.zIndex;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                // Initialize app classes
                if (appType === 'pokemon') {
                    const appInstance = new PokemonGame(window);
                    window.pokemonGame = appInstance;
                } else {
                    setTimeout(() => {
                        if (appType === 'calculator') appInstance = new CalculatorApp(window);
                        else if (appType === 'notepad') appInstance = new NotepadApp(window);
                        else if (appType === 'paint') appInstance = new PaintApp(window);
                        else if (appType === 'snake') appInstance = new SnakeGame(window);
                        else if (appType === 'pacman') appInstance = new PacManGame(window);
                        else if (appType === 'breakout') appInstance = new BreakoutGame(window);
                        else if (appType === 'solitaire') appInstance = new SolitaireGame(window);
                        else if (appType === 'taskmgr') appInstance = new TaskManagerApp(window);
                        else if (appType === 'ie') appInstance = new BrowserApp(window);
                        else if (appType === 'minesweeper') appInstance = new MinesweeperApp(window);
                    }, 100);
                }
            }

            generateVirusWindow(type) {
                if (type === 'memz') {
                    return `<div style="background: #000; color: #0f0; padding: 10px; font-family: Courier; height: 250px; overflow-y: auto; animation: flicker 0.15s;"><p>MEMZ.exe - Memory Corruption Detected</p><p style="animation: glitch 0.2s infinite;">System files corrupted...</p><p>⚠ WARNING: System Integrity Check Failed</p><p style="color: #f00;">CRITICAL ERROR</p></div>`;
                } else if (type === 'virus') {
                    return `<div style="padding: 10px;"><p style="color: #ff0000; font-weight: bold;">⚠ VIRUS DETECTED</p><p>File: BADWARE.EXE</p><p>Status: <span style="color: #ff0000;">INFECTED</span></p><p>Action: Quarantine / Delete / Ignore</p><button onclick="alert('Action not available')">Scan Now</button></div>`;
                } else {
                    return `<div style="padding: 10px;"><p><strong>Windows Security Update</strong></p><p>Downloading: CoolPatch v1.0</p><div style="width: 300px; height: 20px; border: 1px solid #000; margin: 10px 0;"><div style="width: 45%; height: 100%; background: #0080ff;"></div></div><p>45% Complete</p><button onclick="alert('Update starting...')">Install Update</button></div>`;
                }
            }

            openFolder(folderName) {
                const existingWindow = this.windows.find(w => w.folder === folderName && w.filename === folderName);
                if (existingWindow) {
                    existingWindow.element.style.zIndex = ++this.zIndex;
                    existingWindow.element.classList.remove('minimized');
                    return;
                }

                const folder = fileSystem.folders[folderName];
                if (!folder) return;

                const windowElement = this.createFolderWindow(folderName, folder);
                this.container.appendChild(windowElement);

                const windowObj = {
                    filename: folderName,
                    folder: folderName,
                    element: windowElement
                };

                this.windows.push(windowObj);
                this.addTaskbarButton(folderName, windowObj);
                this.makeWindowDraggable(windowElement);
                windowElement.style.zIndex = ++this.zIndex;
            }

            createWindowElement(filename, fileData, fromFolder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${filename}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="file-viewer">
                            <pre>${this.escapeHtml(fileData.content)}</pre>
                        </div>
                    </div>
                `;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                return window;
            }

            createFolderWindow(folderName, folder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                window.style.width = '500px';
                window.style.minHeight = '300px';

                let itemsHtml = '';
                
                // Add subfolders
                if (folder.folders) {
                    for (const [subfolderName, subfolder] of Object.entries(folder.folders)) {
                        itemsHtml += `
                            <div class="folder-item" data-folder="${subfolderName}" data-type="folder">
                                <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                                </svg>
                                <div class="folder-name">${subfolderName}</div>
                            </div>
                        `;
                    }
                }

                // Add files
                for (const [filename, fileData] of Object.entries(folder.files)) {
                    itemsHtml += `
                        <div class="folder-item" data-file="${filename}" data-folder="${folderName}" data-type="file">
                            <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                                <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                            </svg>
                            <div class="folder-name">${filename}</div>
                        </div>
                    `;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${folderName}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="folder-viewer">
                            ${itemsHtml}
                        </div>
                    </div>
                `;

                // Add click handlers
                window.querySelectorAll('.folder-item').forEach(item => {
                    const isFolder = item.dataset.type === 'folder';
                    const name = isFolder ? item.dataset.folder : item.dataset.file;
                    const fromFolder = item.dataset.folder;

                    item.addEventListener('dblclick', () => {
                        if (isFolder) {
                            const subfolder = fileSystem.folders[folderName].folders[name];
                            this.openFolderPath(folderName + '/' + name, subfolder);
                        } else {
                            this.openFile(name, folderName);
                        }
                    });
                });

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));

                return window;
            }

            openFolderPath(path, folder) {
                const windowId = `window-${this.windows.length}`;
                
                const window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.style.left = (50 + Math.random() * 200) + 'px';
                window.style.top = (50 + Math.random() * 200) + 'px';
                window.style.width = '500px';
                window.style.minHeight = '300px';

                let itemsHtml = '';
                
                if (folder.folders) {
                    for (const [subfolderName, subfolder] of Object.entries(folder.folders)) {
                        itemsHtml += `
                            <div class="folder-item" data-folder="${subfolderName}" data-type="folder">
                                <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                    <path d="M 2 6 L 2 20 Q 2 22 4 22 L 20 22 Q 22 22 22 20 L 22 8 Q 22 6 20 6 L 12 6 L 10 4 Q 9 3 8 4 L 4 6 Q 2 6 2 6 Z" fill="#ffdd00" stroke="#000" stroke-width="1"/>
                                    <path d="M 2 6 L 8 6 L 10 4 L 12 6" fill="#ffff99" stroke="none"/>
                                </svg>
                                <div class="folder-name">${subfolderName}</div>
                            </div>
                        `;
                    }
                }

                for (const [filename, fileData] of Object.entries(folder.files)) {
                    itemsHtml += `
                        <div class="folder-item" data-file="${filename}" data-type="file">
                            <svg class="folder-icon" viewBox="0 0 24 24" width="32" height="32">
                                <path d="M 3 2 L 3 20 L 17 20 L 17 7 L 12 2 Z" fill="#ffffff" stroke="#000" stroke-width="1"/>
                                <path d="M 12 2 L 17 7 L 12 7 Z" fill="#e6e6e6" stroke="#000" stroke-width="0.5"/>
                            </svg>
                            <div class="folder-name">${filename}</div>
                        </div>
                    `;
                }

                window.innerHTML = `
                    <div class="window-titlebar">
                        <span class="window-title">${path}</span>
                        <div class="window-buttons">
                            <button class="window-btn minimize-btn" data-window="${windowId}">_</button>
                            <button class="window-btn close-btn" data-window="${windowId}">×</button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="folder-viewer">
                            ${itemsHtml}
                        </div>
                    </div>
                `;

                this.container.appendChild(window);

                window.querySelectorAll('.folder-item').forEach(item => {
                    const isFolder = item.dataset.type === 'folder';
                    const name = isFolder ? item.dataset.folder : item.dataset.file;

                    item.addEventListener('dblclick', () => {
                        if (isFolder) {
                            const subfolder = folder.folders[name];
                            this.openFolderPath(path + '/' + name, subfolder);
                        } else {
                            const fileData = folder.files[name];
                            if (fileData.type === 'app') {
                                this.openApplication(fileData.appType, name);
                            } else {
                                const viewWindow = this.createWindowElement(name, fileData, path);
                                this.container.appendChild(viewWindow);
                                this.windows.push({ filename: name, folder: path, element: viewWindow });
                                this.addTaskbarButton(name, { filename: name, folder: path, element: viewWindow });
                                this.makeWindowDraggable(viewWindow);
                                viewWindow.style.zIndex = ++this.zIndex;
                            }
                        }
                    });
                });

                const windowObj = { filename: path, folder: path, element: window };
                this.windows.push(windowObj);
                this.addTaskbarButton(path.split('/').pop(), windowObj);
                this.makeWindowDraggable(window);
                window.style.zIndex = ++this.zIndex;

                window.querySelector('.minimize-btn').addEventListener('click', () => this.minimizeWindow(windowId));
                window.querySelector('.close-btn').addEventListener('click', () => this.closeWindow(windowId));
            }

            makeWindowDraggable(windowElement) {
                const titlebar = windowElement.querySelector('.window-titlebar');
                let offsetX = 0;
                let offsetY = 0;
                let isDragging = false;

                titlebar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - windowElement.offsetLeft;
                    offsetY = e.clientY - windowElement.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        windowElement.style.left = (e.clientX - offsetX) + 'px';
                        windowElement.style.top = (e.clientY - offsetY) + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                windowElement.addEventListener('mousedown', () => {
                    windowElement.style.zIndex = ++this.zIndex;
                });
            }

            minimizeWindow(windowId) {
                const window = document.getElementById(windowId);
                window.classList.toggle('minimized');
            }

            closeWindow(windowId) {
                const window = document.getElementById(windowId);
                const windowObj = this.windows.find(w => w.element.id === windowId);
                
                if (windowObj) {
                    this.windows = this.windows.filter(w => w !== windowObj);
                }

                const taskbarBtn = document.querySelector(`[data-window-id="${windowId}"]`);
                if (taskbarBtn) taskbarBtn.remove();

                window.remove();
            }

            addTaskbarButton(filename, windowObj) {
                const btn = document.createElement('button');
                btn.className = 'taskbar-window-btn';
                btn.dataset.windowId = windowObj.element.id;
                btn.textContent = filename;
                
                btn.addEventListener('click', () => {
                    const isMinimized = windowObj.element.classList.contains('minimized');
                    if (isMinimized) {
                        windowObj.element.classList.remove('minimized');
                        windowObj.element.style.zIndex = ++this.zIndex;
                    } else {
                        windowObj.element.classList.add('minimized');
                    }
                });

                this.taskbarWindows.appendChild(btn);
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
        }

        // ============= INITIALIZATION =============
        const windowManager = new WindowManager();

        // Desktop icon handlers
        const desktopIcons = document.querySelectorAll('.desktop-icon');
        const desktopContainer = document.querySelector('.desktop-icons');
        
        let draggedIcon = null;
        let dragStartX = 0;
        let dragStartY = 0;

        desktopIcons.forEach(icon => {
            icon.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                draggedIcon = icon;
                dragStartX = e.clientX - icon.offsetLeft;
                dragStartY = e.clientY - icon.offsetTop;
                icon.classList.add('dragging');
                icon.style.position = 'absolute';
            });

            icon.addEventListener('dblclick', () => {
                const file = icon.dataset.file;
                if (file === 'MineSweeper.exe') {
                    windowManager.openApplication('minesweeper', 'MineSweeper.exe');
                } else if (fileSystem.folders[file]) {
                    windowManager.openFolder(file);
                } else {
                    windowManager.openFile(file);
                }
            });

            icon.addEventListener('click', (e) => {
                if (e.detail === 1) {
                    if (!e.ctrlKey && !e.metaKey) {
                        desktopIcons.forEach(i => i.classList.remove('selected'));
                    }
                    icon.classList.toggle('selected');
                }
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (draggedIcon) {
                draggedIcon.style.left = (e.clientX - dragStartX) + 'px';
                draggedIcon.style.top = (e.clientY - dragStartY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if (draggedIcon) {
                draggedIcon.classList.remove('dragging');
                draggedIcon = null;
            }
        });

        // Start button
        document.getElementById('start-button').addEventListener('click', () => {
            const startMenu = document.getElementById('start-menu');
            startMenu.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            const startMenu = document.getElementById('start-menu');
            const startButton = document.getElementById('start-button');
            if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
                startMenu.classList.remove('active');
            }
        });

        // System time
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('system-time').textContent = time;
        }
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
